<div class="inventory-wrap">
  <!-- Header controls -->
  <div class="inventory-header">
    <div class="inventory-search-row">
      <div class="view-toggle" aria-label="Inventory view mode">
        <button id="gridViewBtn" class="view-btn active" type="button" aria-label="Grid view">
          <span class="icon-grid" aria-hidden="true"></span>
        </button>
        <button id="listViewBtn" class="view-btn" type="button" aria-label="List view">
          <span class="icon-list" aria-hidden="true"></span>
        </button>
      </div>
      <input 
        type="text" 
        id="inventorySearch" 
        class="inventory-search" 
        placeholder="Search by bottle name..."
      />
      <button id="addBottleBtn" class="filter-reset-btn is-hidden" type="button">+ Add Bottle</button>
    </div>
    
    <div class="inventory-filters">
      <!-- Base Spirits Filter -->
      <div class="filter-group">
        <label class="filter-label">Base Spirits:</label>
        <div class="filter-pills" id="baseSpiritFilters">
          <button class="filter-pill active" data-spirit="all">All</button>
          <button class="filter-pill" data-spirit="bourbon">Bourbon</button>
          <button class="filter-pill" data-spirit="whiskey">Whiskey</button>
          <button class="filter-pill" data-spirit="rye">Rye</button>
          <button class="filter-pill" data-spirit="scotch">Scotch</button>
          <button class="filter-pill" data-spirit="rum">Rum</button>
          <button class="filter-pill" data-spirit="gin">Gin</button>
          <button class="filter-pill" data-spirit="vodka">Vodka</button>
          <button class="filter-pill" data-spirit="tequila">Tequila</button>
          <button class="filter-pill" data-spirit="mezcal">Mezcal</button>
          <button class="filter-pill" data-spirit="brandy">Brandy</button>
          <button class="filter-pill" data-spirit="cognac">Cognac</button>
        </div>
      </div>
      
      <!-- Mixers/Modifiers Filter -->
      <div class="filter-group">
        <label class="filter-label">Mixers & Modifiers:</label>
        <div class="filter-pills" id="mixerFilters">
          <button class="filter-pill active" data-mixer="all">All</button>
          <button class="filter-pill" data-mixer="liqueur">Liqueur</button>
          <button class="filter-pill" data-mixer="coffeeliqueur">Coffee Liqueur</button>
          <button class="filter-pill" data-mixer="amaro">Amaro</button>
          <button class="filter-pill" data-mixer="vermouth">Vermouth</button>
          <button class="filter-pill" data-mixer="bitters">Bitters</button>
          <button class="filter-pill" data-mixer="syrup">Syrup</button>
          <button class="filter-pill" data-mixer="foam">Foam</button>
          <button class="filter-pill" data-mixer="cordial">Cordial</button>
          <button class="filter-pill" data-mixer="other">Other</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottle Grid -->
  <div id="bottleGrid" class="bottle-grid">
    <!-- Populated by JS -->
  </div>
  
  <div id="emptyState" class="inventory-empty is-hidden">
    <p>No bottles found. <span id="addBottlePrompt" class="is-hidden">Add your first bottle to get started!</span></p>
  </div>
</div>

<!-- Add/Edit Bottle Modal -->
<div class="modal-overlay" id="bottleModalOverlay">
  <div class="modal bottle-modal">
    <div class="modal-header">
      <h2 id="bottleModalTitle">Add Bottle</h2>
    </div>
    <div class="modal-body">
      <div class="modal-panels-container">
        <!-- Main Form Panel -->
        <div class="modal-panel modal-form-panel active">
      <form id="bottleForm">
        <input type="hidden" id="bottleId" />
        
        <div class="form-row">
          <div class="form-group">
            <label for="bottleBrand">Brand *</label>
            <input type="text" id="bottleBrand" required />
          </div>
          <div class="form-group">
            <label for="bottleProduct">Product Name *</label>
            <input type="text" id="bottleProduct" required />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="bottleBaseSpirit">Base Spirit *</label>
            <select id="bottleBaseSpirit" required>
              <option value="">Select...</option>
              <option value="bourbon">Bourbon</option>
              <option value="whiskey">Whiskey</option>
              <option value="rye">Rye</option>
              <option value="scotch">Scotch</option>
              <option value="rum">Rum</option>
              <option value="gin">Gin</option>
              <option value="vodka">Vodka</option>
              <option value="tequila">Tequila</option>
              <option value="mezcal">Mezcal</option>
              <option value="brandy">Brandy</option>
              <option value="cognac">Cognac</option>
              <option value="liqueur">Liqueur</option>
              <option value="coffeeliqueur">Coffee Liqueur</option>
              <option value="amaro">Amaro</option>
              <option value="vermouth">Vermouth</option>
              <option value="bitters">Bitters</option>
              <option value="syrup">Syrup</option>
              <option value="foam">Foam</option>
              <option value="cordial">Cordial</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="bottleCategory">Category (Subcategory)</label>
            <select id="bottleCategory">
              <option value="">None</option>
            </select>
            <small style="display: block; margin-top: 0.25rem; color: #999;">e.g. Reposado, Anejo for Tequila</small>
          </div>
          <div class="form-group">
            <label for="bottleStyle">Style/Type</label>
            <input type="text" id="bottleStyle" placeholder="e.g. Single Malt, Spiced, London Dry" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="bottleABV">ABV %</label>
            <input type="number" id="bottleABV" step="0.1" min="0" max="100" />
          </div>
          <div class="form-group">
            <label for="bottleVolume">Volume (ml)</label>
            <input type="number" id="bottleVolume" step="1" min="0" />
          </div>
          <div class="form-group">
            <label for="bottleQuantity">Quantity *</label>
            <input type="number" id="bottleQuantity" step="1" min="0" value="1" required />
          </div>
          <div class="form-group">
            <label for="bottleUpc">UPC Code</label>
            <input type="text" id="bottleUpc" placeholder="e.g. 619947000020" pattern="\d{6,14}" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="bottlePrice">Price</label>
            <input type="number" id="bottlePrice" step="0.01" min="0" placeholder="USD" />
          </div>
          <div class="form-group">
            <label for="bottlePurchaseDate">Purchase Date</label>
            <input type="date" id="bottlePurchaseDate" />
          </div>
        </div>
        
        <div class="form-group">
          <label for="bottleLocation">Location</label>
          <input type="text" id="bottleLocation" placeholder="e.g. Top shelf, Cabinet A" />
        </div>
        
        <div class="form-group">
          <label for="bottleTags">Tags (comma-separated)</label>
          <input type="text" id="bottleTags" placeholder="e.g. favorite, gift, rare" />
        </div>
        
        <div class="form-group">
          <label for="bottleNotes">Notes</label>
          <textarea id="bottleNotes" rows="3" placeholder="Tasting notes, pairing suggestions, etc."></textarea>
        </div>
        
        <div class="form-group" id="imageUploadGroup" style="display: none;">
          <label for="bottleImage">Bottle Image</label>
          <div class="image-upload-area">
            <input type="file" id="bottleImage" accept="image/*" style="display: none;" />
            <div class="image-preview-container">
              <img id="imagePreviewThumb" style="display: none; max-width: 150px; max-height: 150px; border-radius: 6px;" />
              <div id="imageUploadPlaceholder" class="image-upload-placeholder">
                <span>üì∏ Click to select image</span>
                <small>Max 5MB</small>
              </div>
            </div>
            <button type="button" class="delete-btn" id="clearImageBtn" style="margin-top: 0.5rem; display: none; background: rgba(255, 100, 100, 0.15); border-color: rgba(255, 100, 100, 0.3); color: #ff6b6b;">Clear Image</button>
            <div id="imageUploadStatus" style="margin-top: 0.5rem; font-size: 0.85rem; display: none;"></div>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" id="scanBarcodeBtn" class="scan-barcode-btn">üì∑ Scan Barcode</button>
          <div class="form-actions-right">
            <button type="button" class="cancel-btn" id="bottleModalCancel">Cancel</button>
            <button type="submit" class="submit-btn">Save</button>
          </div>
        </div>
      </form>
        </div>
        
        <!-- UPC Lookup Panel -->
        <div class="modal-panel modal-upc-panel">
          <div class="upc-panel-header">
            <button type="button" class="back-btn" id="upcBackBtn">‚Üê Back to Form</button>
            <h3>Enter UPC Barcode</h3>
          </div>
          <p style="margin-bottom: 1rem; color: #999; font-size: 0.9rem;">Enter the UPC barcode number to lookup product details.</p>
          <form id="barcodeForm">
            <div class="form-group">
              <label for="upcInput">UPC Code *</label>
              <input type="text" id="upcInput" placeholder="e.g. 619947000020" pattern="\d{6,14}" required />
              <small style="color: #999;">Enter 6-14 digit UPC code</small>
            </div>
            <div id="barcodeLookupStatus" style="margin-top: 1rem; padding: 0.75rem; border-radius: 4px; display: none; font-size: 0.9rem;"></div>
            <div class="form-actions" style="margin-top: 1.5rem;">
              <button type="button" class="cancel-btn" id="upcCancelBtn">Cancel</button>
              <button type="submit" class="submit-btn" id="barcodeLookupBtn">Lookup</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModalOverlay">
  <div class="modal delete-modal">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
    </div>
    <div class="modal-body">
      <p id="deleteMessage">Are you sure you want to remove this bottle from inventory?</p>
      <div class="form-actions">
        <button type="button" class="cancel-btn" id="deleteModalCancel">Cancel</button>
        <button type="button" class="delete-btn" id="deleteModalConfirm">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Image Preview Modal (inventory) -->
<div class="modal-overlay" id="imagePreviewOverlay">
  <div class="modal image-preview-modal">
    <div class="modal-body">
      <div class="preview-details">
        <h3 id="previewTitle"></h3>
        <ul class="preview-fields">
          <li><strong>Base Spirit:</strong> <span id="previewBaseSpirit"></span> <span id="previewCategory" style="opacity: 0.7;"></span></li>
          <li><strong>Style:</strong> <span id="previewStyle"></span></li>
          <li><strong>ABV:</strong> <span id="previewABV"></span></li>
          <li><strong>Volume:</strong> <span id="previewVolume"></span></li>
          <li><strong>Quantity:</strong> <span id="previewQuantity"></span></li>
          <li><strong>Price:</strong> <span id="previewPrice"></span></li>
          <li><strong>Purchase Date:</strong> <span id="previewPurchase"></span></li>
          <li><strong>Tags:</strong> <span id="previewTags"></span></li>
        </ul>
        <div class="preview-notes" id="previewNotes"></div>
      </div>
      <div class="preview-image-wrap">
        <img id="imagePreviewImg" alt="Bottle image preview" />
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="close-btn" id="closePreviewBtn">Close</button>
    </div>
  </div>
</div>

<!-- Image Selection Modal (for UPC results with multiple images) -->
<div class="modal-overlay" id="imageSelectOverlay">
  <div class="modal image-select-modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2>Select Product Image</h2>
    </div>
    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
      <div id="imageSelectGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem;"></div>
    </div>
    <div class="form-actions" style="padding: 1rem; border-top: 1px solid #eee;">
      <button type="button" class="cancel-btn" id="imageSelectCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
(() => {
  console.log('üîµ Inventory script starting...');
  
  const API_BASE = 'https://bar.streeter.cc/api';
  const API_ADMIN = 'https://bar.streeter.cc/api/admin';
  
  // Local dev mode disabled so localhost uses the real API (CF Access removed)
  const LOCAL_DEV_MODE = false;
  console.log('üîµ LOCAL_DEV_MODE:', LOCAL_DEV_MODE, 'hostname:', window.location.hostname);
  
  let allBottles = [];
  let isOwner = false;
  let viewMode = 'grid';
  let currentFilters = {
    search: '',
    selectedTypes: new Set()
  };
  let editingBottleId = null;
  let deletingBottleId = null;

  // Helper to get auth headers (include owner or staff token if present)
  function getAuthHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    const ownerToken = localStorage.getItem('ownerToken');
    const staffToken = localStorage.getItem('staffToken');
    const token = ownerToken || staffToken;
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
      console.log('üîµ Adding auth token to request');
      console.log('üîµ Token type:', ownerToken ? 'owner' : 'staff');
      console.log('üîµ Token first 20 chars:', token.slice(0, 20) + '...');
      console.log('üîµ Starts with owner_:', token.startsWith('owner_'));
      console.log('üîµ Starts with staff_:', token.startsWith('staff_'));
    } else {
      console.log('üîµ No owner or staff token found in localStorage');
    }
    return headers;
  }

  // Wait for DOM to be ready
  function init() {
    console.log('üîµ Init function called');
    
    // DOM elements
    const bottleGrid = document.getElementById('bottleGrid');
    const emptyState = document.getElementById('emptyState');
    const addBottlePrompt = document.getElementById('addBottlePrompt');
    const searchInput = document.getElementById('inventorySearch');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const addBottleBtn = document.getElementById('addBottleBtn');
    const baseSpiritFilters = document.getElementById('baseSpiritFilters');
    const mixerFilters = document.getElementById('mixerFilters');
    
    const bottleModal = document.getElementById('bottleModalOverlay');
    const bottleModalTitle = document.getElementById('bottleModalTitle');
    const bottleForm = document.getElementById('bottleForm');
    const scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
    
    const modalFormPanel = document.querySelector('.modal-form-panel');
    const modalUpcPanel = document.querySelector('.modal-upc-panel');
    const upcBackBtn = document.getElementById('upcBackBtn');
    const upcCancelBtn = document.getElementById('upcCancelBtn');
    const barcodeForm = document.getElementById('barcodeForm');
    const upcInput = document.getElementById('upcInput');
    const barcodeLookupStatus = document.getElementById('barcodeLookupStatus');
    
    const deleteModal = document.getElementById('deleteModalOverlay');
    const deleteMessage = document.getElementById('deleteMessage');
    const deleteConfirmBtn = document.getElementById('deleteModalConfirm');
    const imagePreviewOverlay = document.getElementById('imagePreviewOverlay');
    const imagePreviewImg = document.getElementById('imagePreviewImg');
    const previewTitle = document.getElementById('previewTitle');
    const previewBaseSpirit = document.getElementById('previewBaseSpirit');
    const previewCategory = document.getElementById('previewCategory');
    const previewStyle = document.getElementById('previewStyle');
    const previewABV = document.getElementById('previewABV');
    const previewVolume = document.getElementById('previewVolume');
    const previewQuantity = document.getElementById('previewQuantity');
    const previewPrice = document.getElementById('previewPrice');
    const previewPurchase = document.getElementById('previewPurchase');
    const previewLocation = document.getElementById('previewLocation');
    const previewTags = document.getElementById('previewTags');
    const previewNotes = document.getElementById('previewNotes');
    
    // Image upload elements
    const imageUploadGroup = document.getElementById('imageUploadGroup');
    const bottleImage = document.getElementById('bottleImage');
    const imagePreviewThumb = document.getElementById('imagePreviewThumb');
    const imageUploadPlaceholder = document.getElementById('imageUploadPlaceholder');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const deleteImageBtn = document.getElementById('deleteImageBtn');
    const imageUploadStatus = document.getElementById('imageUploadStatus');
    
    console.log('üîµ DOM elements found:', {
      bottleGrid: !!bottleGrid,
      addBottleBtn: !!addBottleBtn,
      searchInput: !!searchInput,
      gridViewBtn: !!gridViewBtn,
      listViewBtn: !!listViewBtn,
      baseSpiritFilters: !!baseSpiritFilters
    });
    
    if (!bottleGrid || !addBottleBtn) {
      console.warn('‚ö†Ô∏è Required DOM elements not found, retrying...');
      setTimeout(init, 50); // Retry after a short delay
      return;
    }
    
    console.log('‚úÖ All DOM elements ready, setting up...');

    // Ensure modals are top-level so z-index can outrank navbar
    try {
      if (bottleModal && bottleModal.parentElement !== document.body) {
        document.body.appendChild(bottleModal);
        console.log('üîß Moved bottleModalOverlay to <body>');
      }
      if (deleteModal && deleteModal.parentElement !== document.body) {
        document.body.appendChild(deleteModal);
        console.log('üîß Moved deleteModalOverlay to <body>');
      }
      if (imagePreviewOverlay && imagePreviewOverlay.parentElement !== document.body) {
        document.body.appendChild(imagePreviewOverlay);
        console.log('üîß Moved imagePreviewOverlay to <body>');
      }
      const imageSelectOverlay = document.getElementById('imageSelectOverlay');
      if (imageSelectOverlay && imageSelectOverlay.parentElement !== document.body) {
        document.body.appendChild(imageSelectOverlay);
        console.log('üîß Moved imageSelectOverlay to <body>');
      }
    } catch (moveErr) {
      console.warn('‚ö†Ô∏è Could not move modals to body:', moveErr);
    }

    // Delegate bottle card action buttons so clicks survive re-renders
    bottleGrid.addEventListener('click', (e) => {
      // Check for owner-only buttons first (higher priority)
      if (isOwner) {
        const editBtn = e.target.closest('.edit-bottle-btn');
        if (editBtn) {
          e.preventDefault();
          e.stopPropagation();
          openEditModal(editBtn.dataset.id);
          return;
        }
        const deleteBtn = e.target.closest('.delete-bottle-btn');
        if (deleteBtn) {
          e.preventDefault();
          e.stopPropagation();
          openDeleteModal(deleteBtn.dataset.id);
          return;
        }
      }
      
      // Image preview modal for entire card (unless clicking action buttons)
      const card = e.target.closest('article.bottle-card');
      if (card) {
        e.preventDefault();
        e.stopPropagation();
        const id = card.getAttribute('data-id');
        const bottle = id ? allBottles.find(b => String(b.id) === String(id)) : null;
        
        // Use uploaded image for popout if available, otherwise use card's generic placeholder
        const uploadedImage = card.getAttribute('data-uploaded-image');
        if (imagePreviewImg) imagePreviewImg.src = uploadedImage || card.querySelector('img')?.src || '';
        
        if (bottle) {
          if (previewTitle) previewTitle.textContent = `${bottle.brand || ''} ${bottle.product_name || ''}`.trim();
          if (previewBaseSpirit) previewBaseSpirit.textContent = bottle.base_spirit || '';
          if (previewCategory) previewCategory.textContent = bottle.category ? `(${bottle.category})` : '';
          if (previewStyle) previewStyle.textContent = bottle.style || '';
          if (previewABV) previewABV.textContent = (typeof bottle.abv === 'number' ? `${bottle.abv}%` : (bottle.abv || ''));
          if (previewVolume) previewVolume.textContent = bottle.volume_ml ? `${bottle.volume_ml} ml` : '';
          if (previewQuantity) previewQuantity.textContent = String(bottle.quantity ?? '');
          if (previewPrice) previewPrice.textContent = (typeof bottle.price_cents === 'number') ? `$${(bottle.price_cents/100).toFixed(2)} ${bottle.currency || 'USD'}` : '';
          if (previewPurchase) previewPurchase.textContent = bottle.purchase_date || '';
          if (previewTags) previewTags.textContent = Array.isArray(bottle.tags) ? bottle.tags.join(', ') : '';
          if (previewNotes) previewNotes.textContent = bottle.notes || '';
        } else {
          if (previewTitle) previewTitle.textContent = '';
          if (previewBaseSpirit) previewBaseSpirit.textContent = '';
          if (previewCategory) previewCategory.textContent = '';
          if (previewStyle) previewStyle.textContent = '';
          if (previewABV) previewABV.textContent = '';
          if (previewVolume) previewVolume.textContent = '';
          if (previewQuantity) previewQuantity.textContent = '';
          if (previewPrice) previewPrice.textContent = '';
          if (previewPurchase) previewPurchase.textContent = '';
          if (previewTags) previewTags.textContent = '';
          if (previewNotes) previewNotes.textContent = '';
        }
        imagePreviewOverlay.classList.add('active');
        return;
      }
    });
  
    // Placeholder images based on spirit type or category
    const spiritPlaceholders = {
      bourbon: 'assets/bottles/bourbon.png',
      whiskey: 'assets/bottles/whiskey.png',
      rye: 'assets/bottles/rye.png',
      scotch: 'assets/bottles/scotch.png',
      rum: 'assets/bottles/rum.png',
      gin: 'assets/bottles/gin.png',
      vodka: 'assets/bottles/vodka.png',
      tequila: 'assets/bottles/tequila.png',
      blanco: 'assets/bottles/tequila.png',
      reposado: 'assets/bottles/reposado.png',
      anejo: 'assets/bottles/reposado.png',
      mezcal: 'assets/bottles/mezcal.png',
      brandy: 'assets/bottles/brandy.png',
      cognac: 'assets/bottles/cognac.png',
      liqueur: 'assets/bottles/liqueur.png',
      coffeeliqueur: 'assets/bottles/coffeeliqueur.png',
      amaro: 'assets/bottles/amaro.png',
      vermouth: 'assets/bottles/vermouth.png',
      bitters: 'assets/bottles/bitters.png',
      syrup: 'assets/bottles/syrup.png',
      foam: 'assets/bottles/foam.png',
      cordial: 'assets/bottles/cordial.png',
      other: 'assets/bottles/other.png',
      // Scotch subcategories
      'single-malt': 'assets/bottles/scotch.png',
      'blended-malt': 'assets/bottles/blendedscotch.png',
      'blended': 'assets/bottles/blendedscotch.png',
      'single-grain': 'assets/bottles/scotch.png',
      // Rum subcategories
      'light': 'assets/bottles/rum.png',
      'gold': 'assets/bottles/rum.png',
      'dark': 'assets/bottles/rum.png',
      'spiced': 'assets/bottles/rum.png',
      // Brandy subcategories
      'vs': 'assets/bottles/brandy.png',
      'vsop': 'assets/bottles/brandy.png',
      'xo': 'assets/bottles/brandy.png',
      // Whiskey subcategories
      'blended-whiskey': 'assets/bottles/whiskey.png',
      // Gin subcategories
      'london-dry': 'assets/bottles/gin.png',
      'navy': 'assets/bottles/gin.png',
      'old-tom': 'assets/bottles/gin.png',
      // Amaro subcategories
      'nonino': 'assets/bottles/amaro.png',
      'montenegro': 'assets/bottles/amaro.png',
      'bitter': 'assets/bottles/apertif.png',
      // Liqueur subcategories
      'herbal': 'assets/bottles/herbal.png',
      'fruit': 'assets/bottles/herbal.png',
      'cream': 'assets/bottles/cream.png',
      // Cordial subcategories
      'citrus': 'assets/bottles/citrus.png',
      'berry': 'assets/bottles/cordial.png',
      'spiced': 'assets/bottles/cordial.png',
      'floral': 'assets/bottles/floral.png',
      'tropical': 'assets/bottles/cordial.png',
      'herbal': 'assets/bottles/herbal.png',
      'stonefruit': 'assets/bottles/cordial.png'
    };

    // Category options for each base spirit
    const spiritCategories = {
      tequila: [
        { value: 'blanco', label: 'Blanco (Silver)' },
        { value: 'reposado', label: 'Reposado' },
        { value: 'anejo', label: 'Anejo' }
      ],
      mezcal: [
        { value: 'blanco', label: 'Blanco' },
        { value: 'reposado', label: 'Reposado' },
        { value: 'anejo', label: 'Anejo' }
      ],
      scotch: [
        { value: 'single-malt', label: 'Single Malt' },
        { value: 'blended-malt', label: 'Blended Malt' },
        { value: 'blended', label: 'Blended' },
        { value: 'single-grain', label: 'Single Grain' }
      ],
      rum: [
        { value: 'light', label: 'Light/White' },
        { value: 'gold', label: 'Gold/Amber' },
        { value: 'dark', label: 'Dark' },
        { value: 'spiced', label: 'Spiced' }
      ],
      brandy: [
        { value: 'vs', label: 'VS (Very Special)' },
        { value: 'vsop', label: 'VSOP (Very Superior Old Pale)' },
        { value: 'xo', label: 'XO (Extra Old)' }
      ],
      whiskey: [
        { value: 'blended', label: 'Blended' },
        { value: 'single-malt', label: 'Single Malt' },
        { value: 'bourbon', label: 'Bourbon' },
        { value: 'rye', label: 'Rye' }
      ],
      gin: [
        { value: 'london-dry', label: 'London Dry' },
        { value: 'navy', label: 'Navy Strength' },
        { value: 'old-tom', label: 'Old Tom' }
      ],
      liqueur: [
        { value: 'amaro', label: 'Amaro' },
        { value: 'herbal', label: 'Herbal' },
        { value: 'fruit', label: 'Fruit' },
        { value: 'cream', label: 'Cream' }
      ],
      amaro: [
        { value: 'nonino', label: 'Nonino' },
        { value: 'montenegro', label: 'Montenegro' },
        { value: 'bitter', label: 'Bitter' }
      ],
      cordial: [
        { value: 'citrus', label: 'Citrus' },
        { value: 'berry', label: 'Berry' },
        { value: 'spiced', label: 'Spiced' },
        { value: 'floral', label: 'Floral' },
        { value: 'tropical', label: 'Tropical' },
        { value: 'herbal', label: 'Herbal' },
        { value: 'stonefruit', label: 'Stonefruit' }
      ]
    };

    // Load bottles from API
    async function loadBottles() {
      console.log('üîµ loadBottles called, LOCAL_DEV_MODE:', LOCAL_DEV_MODE);
      try {
        // In local dev mode, enable owner features and use empty inventory
        if (LOCAL_DEV_MODE) {
          console.log('üîß Local dev mode: Owner features enabled');
          isOwner = true;
          console.log('üîµ Removing is-hidden from addBottleBtn');
          console.log('üîµ Button before:', addBottleBtn.classList.toString());
          addBottleBtn.classList.remove('is-hidden');
          console.log('üîµ Button after:', addBottleBtn.classList.toString());
          console.log('üîµ Button display:', window.getComputedStyle(addBottleBtn).display);
          console.log('üîµ Button visibility:', window.getComputedStyle(addBottleBtn).visibility);
          addBottlePrompt.classList.remove('is-hidden');
          allBottles = [];
          console.log('üîµ About to call renderBottles');
          renderBottles();
          console.log('üîµ After renderBottles, button classes:', addBottleBtn.classList.toString());
          return;
        }
      
      console.log('üîµ Not local dev, fetching from API...');
      
      // Check if user is owner (from login)
      const isOwnerLoggedIn = localStorage.getItem('isOwner') === 'true';
      if (isOwnerLoggedIn) {
        console.log('‚úÖ Authenticated as OWNER');
        isOwner = true;
        addBottleBtn.classList.remove('is-hidden');
        addBottlePrompt.classList.remove('is-hidden');
      } else {
        console.log('‚úÖ Authenticated as STAFF (read-only)');
        isOwner = false;
      }
      
      // Fetch bottles
      const resp = await fetch(`${API_BASE}/bottles`, {
        headers: getAuthHeaders(),
        credentials: 'include',
        mode: 'cors'
      });
      
      if (!resp.ok) {
        throw new Error(`Failed to load bottles: ${resp.statusText}`);
      }
      
      const data = await resp.json();
      allBottles = data.bottles || [];
      renderBottles();
    } catch (err) {
      console.error('Error loading bottles:', err);
      bottleGrid.innerHTML = '<p style="text-align:center;color:#f66;padding:2rem;">Failed to load inventory. Please try again.</p>';
    }
    }

    // Expand selected types to handle hierarchy (e.g., whiskey ‚Üí bourbon+rye+whiskey)
    function expandSelectedTypes(selected) {
      const expanded = new Set(selected);
      if (selected.has('whiskey')) {
        expanded.add('whiskey');
        expanded.add('bourbon');
        expanded.add('rye');
      }
      // Add other hierarchical relationships here if desired
      // For now, scotch remains its own category.
      return expanded;
    }

    // Filter bottles based on current filters
    function getFilteredBottles() {
    const hasTypeFilters = currentFilters.selectedTypes && currentFilters.selectedTypes.size > 0;
    const expandedTypes = hasTypeFilters ? expandSelectedTypes(currentFilters.selectedTypes) : null;
    return allBottles.filter(bottle => {
      // Search filter (substring match on brand + product)
      if (currentFilters.search) {
        const searchLower = currentFilters.search.toLowerCase();
        const brandMatch = (bottle.brand || '').toLowerCase().includes(searchLower);
        const productMatch = (bottle.product_name || '').toLowerCase().includes(searchLower);
        if (!brandMatch && !productMatch) return false;
      }
      
      // Type filters (union of base spirits + mixers) with hierarchy
      if (hasTypeFilters) {
        const t = (bottle.base_spirit || '').toLowerCase();
        if (!expandedTypes.has(t)) return false;
      }
      
      return true;
      });
    }

    // Render bottles to grid
    function renderBottles() {
    bottleGrid.classList.toggle('list-view', viewMode === 'list');
    const filtered = getFilteredBottles();
    
    if (filtered.length === 0) {
      bottleGrid.innerHTML = '';
      emptyState.classList.remove('is-hidden');
      return;
    }
    
    emptyState.classList.add('is-hidden');
    bottleGrid.innerHTML = filtered.map(bottle => {
      // Use category icon if available, otherwise use base spirit icon
      const iconKey = bottle.category?.toLowerCase() || bottle.base_spirit?.toLowerCase();
      const placeholder = spiritPlaceholders[iconKey] || spiritPlaceholders.other;
      
      // Always use generic placeholder for card display, store uploaded image for popout
      const cardImageSrc = placeholder;
      const uploadedImageSrc = bottle.image_url || '';
      
      return `
        <article class="bottle-card" data-id="${bottle.id}" data-uploaded-image="${uploadedImageSrc}">
          <img class="placeholder-img" src="${cardImageSrc}" alt="${bottle.brand} ${bottle.product_name}" />
          <div class="bottle-info">
            <div class="bottle-title">
              <h3>${bottle.brand || 'Unknown'}</h3>
              <p class="bottle-product">${bottle.product_name || ''}</p>
            </div>
            <div class="bottle-meta">
              <p class="bottle-details">
                <span class="bottle-spirit">${bottle.base_spirit || ''}</span>
                ${bottle.category ? `<span class="bottle-category" style="margin-left: 0.5rem; opacity: 0.8;">(${bottle.category})</span>` : ''}
                ${bottle.volume_ml ? `<span class="bottle-volume">${bottle.volume_ml}ml</span>` : ''}
              </p>
              ${bottle.location ? `<p class="bottle-location">üìç ${bottle.location}</p>` : ''}
              <p class="bottle-quantity">Qty: ${bottle.quantity || 0}</p>
            </div>
          </div>
          ${isOwner ? `
            <div class="bottle-actions">
              <button class="edit-bottle-btn" data-id="${bottle.id}">Edit</button>
              <button class="delete-bottle-btn" data-id="${bottle.id}">Delete</button>
            </div>
          ` : ''}
        </article>
      `;
    }).join('');
    }

    // Update category dropdown based on selected base spirit
    function updateCategoryDropdown() {
      const baseSpiritSelect = document.getElementById('bottleBaseSpirit');
      const categorySelect = document.getElementById('bottleCategory');
      const selectedSpirit = baseSpiritSelect.value;
      
      // Clear existing options (except "None")
      while (categorySelect.options.length > 1) {
        categorySelect.remove(1);
      }
      
      // Add options for the selected spirit
      if (selectedSpirit && spiritCategories[selectedSpirit]) {
        spiritCategories[selectedSpirit].forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.value;
          option.textContent = cat.label;
          categorySelect.appendChild(option);
        });
      }
    }

    // Open add modal
    function openAddModal() {
      console.log('üîµ openAddModal called');
      editingBottleId = null;
      bottleModalTitle.textContent = 'Add Bottle';
      bottleForm.reset();
      document.getElementById('bottleId').value = '';
      document.getElementById('bottleCategory').value = '';
      
      // Update category dropdown for blank spirit selection
      updateCategoryDropdown();
      
      // Reset image state for new bottle
      selectedImageFile = null;
      bottleImage.value = '';
      imagePreviewThumb.src = '';
      imagePreviewThumb.style.display = 'none';
      imageUploadPlaceholder.style.display = 'flex';
      clearImageBtn.style.display = 'none';
      imageUploadStatus.style.display = 'none';
      imageUploadGroup.style.display = 'block';
      
      console.log('üîµ Adding active class to modal');
      bottleModal.classList.add('active');
      console.log('üîµ Modal classes:', bottleModal.className);
    }

    // Open edit modal
    function openEditModal(id) {
      const bottle = allBottles.find(b => String(b.id) === String(id));
      if (!bottle) return;
      
      editingBottleId = id;
      bottleModalTitle.textContent = 'Edit Bottle';
      
      document.getElementById('bottleId').value = bottle.id;
      document.getElementById('bottleBrand').value = bottle.brand || '';
      document.getElementById('bottleProduct').value = bottle.product_name || '';
    document.getElementById('bottleBaseSpirit').value = bottle.base_spirit || '';
    document.getElementById('bottleStyle').value = bottle.style || '';
    document.getElementById('bottleABV').value = bottle.abv || '';
    document.getElementById('bottleVolume').value = bottle.volume_ml || '';
    document.getElementById('bottleQuantity').value = bottle.quantity || 1;
    document.getElementById('bottlePrice').value = bottle.price_cents ? (bottle.price_cents / 100).toFixed(2) : '';
    document.getElementById('bottlePurchaseDate').value = bottle.purchase_date || '';
    document.getElementById('bottleLocation').value = bottle.location || '';
    document.getElementById('bottleUpc').value = bottle.upc || '';
      document.getElementById('bottleTags').value = Array.isArray(bottle.tags) ? bottle.tags.join(', ') : '';
      document.getElementById('bottleNotes').value = bottle.notes || '';
      
      // Update category dropdown and set the value
      updateCategoryDropdown();
      document.getElementById('bottleCategory').value = bottle.category || '';
      
      // Show image upload area when editing
      imageUploadGroup.style.display = 'block';
      selectedImageFile = null;
      bottleImage.value = '';
      
      // Populate image preview if exists
      if (bottle.image_url) {
        imagePreviewThumb.src = bottle.image_url;
        imagePreviewThumb.style.display = 'block';
        imageUploadPlaceholder.style.display = 'none';
        clearImageBtn.style.display = 'inline-block';
      } else {
        imagePreviewThumb.src = '';
        imagePreviewThumb.style.display = 'none';
        imageUploadPlaceholder.style.display = 'flex';
        clearImageBtn.style.display = 'none';
      }
      imageUploadStatus.style.display = 'none';
      
      bottleModal.classList.add('active');
    }

    // Close modals
    function closeBottleModal() {
      bottleModal.classList.remove('active');
      editingBottleId = null;
      // Reset to form panel when closing
      setTimeout(() => {
        showFormPanel();
        upcInput.value = '';
        barcodeLookupStatus.style.display = 'none';
      }, 300);
    }

    function closeDeleteModal() {
      deleteModal.classList.remove('active');
      deletingBottleId = null;
    }

    // Switch to UPC panel
    function showUpcPanel() {
      modalFormPanel.classList.remove('active');
      modalUpcPanel.classList.add('active');
      upcInput.value = '';
      barcodeLookupStatus.style.display = 'none';
      setTimeout(() => upcInput.focus(), 350);
    }

    // Switch back to form panel
    function showFormPanel() {
      modalUpcPanel.classList.remove('active');
      modalFormPanel.classList.add('active');
    }

    // Show status message in UPC panel
    function showBarcodeStatus(message, type = 'info') {
      barcodeLookupStatus.textContent = message;
      barcodeLookupStatus.style.display = 'block';
      barcodeLookupStatus.style.backgroundColor = type === 'error' ? '#fee' : type === 'success' ? '#efe' : '#eef';
      barcodeLookupStatus.style.color = type === 'error' ? '#c00' : type === 'success' ? '#060' : '#006';
    }

    // Handle barcode lookup
    async function lookupBarcode(e) {
      e.preventDefault();
      
      const upc = upcInput.value.trim();
      if (!upc || !/^\d{6,14}$/.test(upc)) {
        showBarcodeStatus('Please enter a valid 6-14 digit UPC code', 'error');
        return;
      }

      try {
        showBarcodeStatus('Looking up UPC...', 'info');
        
        const resp = await fetch(`${API_ADMIN}/upc/${upc}`, {
          method: 'GET',
          headers: getAuthHeaders(),
          credentials: 'include',
          mode: 'cors'
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${resp.status}`);
        }

        const data = await resp.json();
        
        if (!data.success || !data.product) {
          showBarcodeStatus('No product found for this UPC', 'error');
          return;
        }

        // Show rate limit info
        if (data.rateLimit && data.rateLimit.remaining) {
          console.log(`üîµ UPC API rate limit: ${data.rateLimit.remaining}/${data.rateLimit.limit} remaining`);
        }

        // Switch back to form and populate fields
        showFormPanel();
        populateFormFromUPC(data.product);
        
      } catch (err) {
        console.error('‚õî Error looking up UPC:', err);
        showBarcodeStatus(`Lookup failed: ${err.message}`, 'error');
      }
    }

    // Populate bottle form from UPC data
    function populateFormFromUPC(product) {
      console.log('üîµ Populating form from UPC data:', product);
      
      // Set the UPC code that was just looked up
      if (product.upc) {
        document.getElementById('bottleUpc').value = product.upc;
      }
      
      // Parse brand and product name from title
      // Example: "Tito's Handmade Vodka - 750ml Bottle"
      const title = product.title || '';
      const brand = product.brand || '';
      
      // Set brand
      if (brand) {
        document.getElementById('bottleBrand').value = brand;
      }
      
      // Set product name (use title if no specific product name)
      let productName = title;
      if (brand && title.startsWith(brand)) {
        productName = title.substring(brand.length).trim();
        // Remove leading dashes
        productName = productName.replace(/^[-‚Äì‚Äî]\s*/, '');
      }
      document.getElementById('bottleProduct').value = productName;
      
      // Try to detect base spirit from category or title
      const category = (product.category || '').toLowerCase();
      const titleLower = title.toLowerCase();
      
      let baseSpirit = '';
      if (category.includes('vodka') || titleLower.includes('vodka')) baseSpirit = 'vodka';
      else if (category.includes('whiskey') || titleLower.includes('whiskey')) baseSpirit = 'whiskey';
      else if (category.includes('bourbon') || titleLower.includes('bourbon')) baseSpirit = 'bourbon';
      else if (category.includes('rye') || titleLower.includes(' rye')) baseSpirit = 'rye';
      else if (category.includes('scotch') || titleLower.includes('scotch')) baseSpirit = 'scotch';
      else if (category.includes('rum') || titleLower.includes('rum')) baseSpirit = 'rum';
      else if (category.includes('gin') || titleLower.includes('gin')) baseSpirit = 'gin';
      else if (category.includes('tequila') || titleLower.includes('tequila')) baseSpirit = 'tequila';
      else if (category.includes('mezcal') || titleLower.includes('mezcal')) baseSpirit = 'mezcal';
      else if (category.includes('brandy') || titleLower.includes('brandy')) baseSpirit = 'brandy';
      else if (category.includes('cognac') || titleLower.includes('cognac')) baseSpirit = 'cognac';
      
      if (baseSpirit) {
        document.getElementById('bottleBaseSpirit').value = baseSpirit;
      }
      
      // Parse volume from title (e.g., "750ml", "750 ml", "1L", "1.75L")
      const volumeMatch = title.match(/(\d+(?:\.\d+)?)\s*(ml|l)/i);
      if (volumeMatch) {
        let volume = parseFloat(volumeMatch[1]);
        const unit = volumeMatch[2].toLowerCase();
        if (unit === 'l') volume *= 1000; // Convert liters to ml
        document.getElementById('bottleVolume').value = Math.round(volume);
      }
      
      // Set price if available (convert to dollars)
      if (product.offers && product.offers.length > 0) {
        const prices = product.offers.map(o => o.price).filter(p => p > 0);
        if (prices.length > 0) {
          const avgPrice = prices.reduce((a, b) => a + b) / prices.length;
          document.getElementById('bottlePrice').value = avgPrice.toFixed(2);
        }
      }
      
      // Set notes from description
      if (product.description) {
        document.getElementById('bottleNotes').value = product.description;
      }
      
      // Auto-fetch and preview the product image(s)
      if (product.images && product.images.length > 0) {
        console.log('üîµ Product images available:', product.images);
        if (product.images.length === 1) {
          // Single image - just use it
          downloadAndPreviewImage(product.images[0], product.title || 'bottle');
        } else {
          // Multiple images - let user choose
          showImageSelector(product.images, product.title || 'bottle');
        }
      }
    }

    // Show image selector for multiple images
    function showImageSelector(imageUrls, filename) {
      const grid = document.getElementById('imageSelectGrid');
      grid.innerHTML = '';
      
      imageUrls.forEach((url, index) => {
        const thumbContainer = document.createElement('div');
        thumbContainer.style.cssText = 'position: relative; cursor: pointer; border-radius: 6px; overflow: hidden; border: 2px solid transparent; transition: all 0.2s; background: #f0f0f0; aspect-ratio: 1;';
        thumbContainer.onmouseenter = () => thumbContainer.style.borderColor = '#4CAF50';
        thumbContainer.onmouseleave = () => thumbContainer.style.borderColor = 'transparent';
        
        const img = document.createElement('img');
        img.src = url;
        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        img.onload = () => img.style.opacity = '1';
        img.onerror = () => {
          img.style.display = 'none';
          thumbContainer.style.display = 'flex';
          thumbContainer.style.alignItems = 'center';
          thumbContainer.style.justifyContent = 'center';
          thumbContainer.innerHTML = '‚ùå Failed to load';
        };
        
        thumbContainer.appendChild(img);
        thumbContainer.onclick = async () => {
          console.log('üîµ User selected image', index + 1);
          await downloadAndPreviewImage(url, filename);
          closeImageSelector();
        };
        
        grid.appendChild(thumbContainer);
      });
      
      document.getElementById('imageSelectOverlay').classList.add('active');
    }

    function closeImageSelector() {
      document.getElementById('imageSelectOverlay').classList.remove('active');
    }

    // Download image from UPC lookup and prompt user
    async function downloadAndPreviewImage(imageUrl, filename) {
      try {
        console.log('üîµ Downloading image from UPC lookup:', imageUrl);
        
        // Fetch the image
        const response = await fetch(imageUrl);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const blob = await response.blob();
        const ext = blob.type.split('/')[1] || 'jpg';
        const file = new File([blob], `${filename.replace(/\s+/g, '-')}.${ext}`, { type: blob.type });
        
        // Set and preview the image
        setImageFile(file);
        showImagePreview(file);
        
      } catch (err) {
        console.error('‚õî Failed to download image from UPC lookup:', err);
        // Don't show error - just let user select manually if they want
      }
    }
    
    // Store file for later upload
    let selectedImageFile = null;
    
    function setImageFile(file) {
      selectedImageFile = file;
      console.log('üîµ Image file selected:', file.name, file.size, 'bytes');
    }
    
    function showImagePreview(file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        imagePreviewThumb.src = event.target?.result;
        imagePreviewThumb.style.display = 'block';
        imageUploadPlaceholder.style.display = 'none';
        clearImageBtn.style.display = 'inline-block';
      };
      reader.readAsDataURL(file);
    }

    // Image upload handlers
    function showImageStatus(message, type = 'info') {
      imageUploadStatus.textContent = message;
      imageUploadStatus.style.display = 'block';
      imageUploadStatus.className = type;
    }

    function onImageSelected(e) {
      const file = e.target.files?.[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        showImageStatus('Please select an image file', 'error');
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showImageStatus('File too large. Maximum 5MB.', 'error');
        return;
      }

      // Store and preview
      setImageFile(file);
      showImagePreview(file);
      imageUploadStatus.style.display = 'none';
    }
    
    async function clearImageFile() {
      // If editing an existing bottle with an image, delete it from R2
      if (editingBottleId && imagePreviewThumb.src) {
        try {
          console.log('üîµ Deleting image for bottle:', editingBottleId);
          const resp = await fetch(`${API_ADMIN}/bottles/${editingBottleId}/image`, {
            method: 'DELETE',
            headers: getAuthHeaders(),
            credentials: 'include',
            mode: 'cors'
          });

          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error || `HTTP ${resp.status}`);
          }

          console.log('‚úì Image deleted from R2');
        } catch (err) {
          console.error('‚õî Failed to delete image:', err);
          showImageStatus(`Delete failed: ${err.message}`, 'error');
          return;
        }
      }

      // Clear the UI and selected file
      selectedImageFile = null;
      bottleImage.value = '';
      imagePreviewThumb.src = '';
      imagePreviewThumb.style.display = 'none';
      imageUploadPlaceholder.style.display = 'flex';
      clearImageBtn.style.display = 'none';
      imageUploadStatus.style.display = 'none';
    }

    // Auto-upload image after bottle is saved
    async function uploadImageForBottle(bottleId) {
      if (!selectedImageFile) {
        console.log('üîµ No image to upload');
        return;
      }

      try {
        showImageStatus('Uploading image...', 'loading');
        console.log('üîµ Uploading image for bottle:', bottleId, selectedImageFile.name);
        
        // Read file as array buffer for binary upload
        const arrayBuffer = await selectedImageFile.arrayBuffer();
        
        // Build headers with auth and content type
        const headers = getAuthHeaders();
        headers['Content-Type'] = selectedImageFile.type;
        
        const resp = await fetch(`${API_ADMIN}/bottles/${bottleId}/image`, {
          method: 'POST',
          headers: headers,
          body: arrayBuffer,
          credentials: 'include',
          mode: 'cors'
        });

        console.log('üîµ Upload response status:', resp.status);
        
        if (!resp.ok) {
          let errMsg = `HTTP ${resp.status}`;
          try {
            const err = await resp.json();
            errMsg = err.error || errMsg;
          } catch (e) {
            const text = await resp.text();
            console.error('üîµ Response body:', text);
          }
          throw new Error(errMsg);
        }

        const data = await resp.json();
        console.log('üîµ Image uploaded successfully:', data.imageUrl);
        showImageStatus('‚úì Image uploaded', 'success');
        selectedImageFile = null;
        bottleImage.value = '';
        
      } catch (err) {
        console.error('‚õî Image upload error:', err);
        showImageStatus(`Image upload failed: ${err.message}`, 'error');
      }
    }

    // Submit bottle form
    async function submitBottle(e) {
      e.preventDefault();
      
      const formData = {
        brand: document.getElementById('bottleBrand').value.trim(),
        product_name: document.getElementById('bottleProduct').value.trim(),
        base_spirit: document.getElementById('bottleBaseSpirit').value,
        category: document.getElementById('bottleCategory').value || null,
        style: document.getElementById('bottleStyle').value.trim() || null,
        abv: parseFloat(document.getElementById('bottleABV').value) || null,
        volume_ml: parseInt(document.getElementById('bottleVolume').value) || null,
        quantity: parseInt(document.getElementById('bottleQuantity').value) || 1,
        price_cents: document.getElementById('bottlePrice').value ? Math.round(parseFloat(document.getElementById('bottlePrice').value) * 100) : null,
        currency: document.getElementById('bottlePrice').value ? 'USD' : null,
        purchase_date: document.getElementById('bottlePurchaseDate').value || null,
        location: document.getElementById('bottleLocation').value.trim() || null,
        notes: document.getElementById('bottleNotes').value.trim() || null,
        upc: document.getElementById('bottleUpc').value.trim() || null,
        tags: document.getElementById('bottleTags').value
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0)
      };
      
      try {
        // Local dev mode: Simulate adding to local array
        if (LOCAL_DEV_MODE) {
          if (editingBottleId !== null) {
            const index = allBottles.findIndex(b => String(b.id) === String(editingBottleId));
            if (index !== -1) {
              allBottles[index] = { ...allBottles[index], ...formData };
            }
          } else {
            const newBottle = {
              id: Date.now(),
              ...formData,
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString()
            };
            allBottles.push(newBottle);
          }
          closeBottleModal();
          renderBottles();
          return;
        }
        
        const url = editingBottleId ? `${API_ADMIN}/bottles/${editingBottleId}` : `${API_ADMIN}/bottles`;
        const method = editingBottleId ? 'PUT' : 'POST';
        
        console.log('üîµ Saving bottle:', { method, url, formData });
        const resp = await fetch(url, {
          method,
          headers: getAuthHeaders(),
          body: JSON.stringify(formData),
          credentials: 'include',
          mode: 'cors'
        });
        
        if (!resp.ok) {
          let errMsg = `HTTP ${resp.status} ${resp.statusText}`;
          try {
            const ct = resp.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
              const err = await resp.json();
              errMsg = err.error || errMsg;
            } else {
              const txt = await resp.text();
              errMsg = txt?.slice(0, 300) || errMsg;
            }
          } catch {}
          throw new Error(errMsg);
        }
        
        // Get the bottle ID from the response or use editingBottleId
        let bottleId = editingBottleId;
        if (!editingBottleId) {
          // For new bottles, parse the response to get the created bottle ID
          const data = await resp.json();
          bottleId = data.bottle?.id;
          if (!bottleId) {
            console.error('‚õî No bottle ID in response:', data);
          }
        }
        
        // Upload image if one was selected
        if (selectedImageFile && bottleId) {
          console.log('üîµ Auto-uploading image for bottle:', bottleId);
          await uploadImageForBottle(bottleId);
        }
        
        closeBottleModal();
        await loadBottles();
      } catch (err) {
        console.error('‚õî Error saving bottle (network/CORS/auth?):', err);
        const hint = 'If this says Failed to fetch, check: 1) Logged into CF Access at /api/admin/auth/check, 2) Worker route for /api/admin/* exists, 3) CORS allows https://streeter.cc';
        alert(`Failed to save bottle: ${err.message || err}.\n${hint}`);
      }
    }

    // Open delete modal
    function openDeleteModal(id) {
      const bottle = allBottles.find(b => String(b.id) === String(id));
      if (!bottle) return;
      
      deletingBottleId = id;
      deleteMessage.textContent = `Are you sure you want to remove ${bottle.brand} ${bottle.product_name} from inventory?`;
      deleteModal.classList.add('active');
    }

    // Confirm delete
    async function confirmDelete() {
      if (!deletingBottleId) return;
      
      try {
        // Local dev mode: Remove from local array
        if (LOCAL_DEV_MODE) {
          allBottles = allBottles.filter(b => String(b.id) !== String(deletingBottleId));
          closeDeleteModal();
          renderBottles();
          return;
        }
        
        const resp = await fetch(`${API_ADMIN}/bottles/${deletingBottleId}`, {
          method: 'DELETE',
        headers: getAuthHeaders(),
        });
        
        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.error || 'Failed to delete bottle');
        }
        
        closeDeleteModal();
        await loadBottles();
      } catch (err) {
        console.error('Error deleting bottle:', err);
        alert(`Failed to delete bottle: ${err.message}`);
      }
    }

    // Search handler
    searchInput.addEventListener('input', (e) => {
      currentFilters.search = e.target.value.trim();
      renderBottles();
    });

    // Filter handlers (multi-select)
    function setAllActive(groupEl, allAttr) {
      groupEl.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
      const allBtn = groupEl.querySelector(allAttr);
      if (allBtn) allBtn.classList.add('active');
    }

    function clearAllSelections() {
      currentFilters.selectedTypes.clear();
      setAllActive(baseSpiritFilters, '[data-spirit="all"]');
      setAllActive(mixerFilters, '[data-mixer="all"]');
    }

    function toggleTypeSelection(type, groupEl, allSelector) {
      // Remove 'All' active when selecting a specific type
      const allBtn = groupEl.querySelector(allSelector);
      if (allBtn) allBtn.classList.remove('active');

      // Find the button for this type in the group
      const btn = Array.from(groupEl.querySelectorAll('.filter-pill')).find(p => (p.dataset.spirit || p.dataset.mixer) === type);
      const willActivate = !(btn && btn.classList.contains('active'));

      if (btn) btn.classList.toggle('active', willActivate);
      if (willActivate) currentFilters.selectedTypes.add(type);
      else currentFilters.selectedTypes.delete(type);

      // If no types selected at all, revert to All on both groups
      if (currentFilters.selectedTypes.size === 0) {
        setAllActive(baseSpiritFilters, '[data-spirit="all"]');
        setAllActive(mixerFilters, '[data-mixer="all"]');
      }
    }

    baseSpiritFilters.addEventListener('click', (e) => {
      if (!e.target.classList.contains('filter-pill')) return;
      e.preventDefault();
      e.stopPropagation();
      const val = e.target.dataset.spirit;
      if (!val) return;
      if (val === 'all') {
        clearAllSelections();
      } else {
        toggleTypeSelection(val, baseSpiritFilters, '[data-spirit="all"]');
      }
      renderBottles();
    });

    mixerFilters.addEventListener('click', (e) => {
      if (!e.target.classList.contains('filter-pill')) return;
      e.preventDefault();
      e.stopPropagation();
      const val = e.target.dataset.mixer;
      if (!val) return;
      if (val === 'all') {
        clearAllSelections();
      } else {
        toggleTypeSelection(val, mixerFilters, '[data-mixer="all"]');
      }
      renderBottles();
    });

    // Modal event listeners
    console.log('üîµ Setting up event listeners...');
    console.log('üîµ addBottleBtn element:', addBottleBtn);
    console.log('üîµ addBottleBtn id:', addBottleBtn.id);
    console.log('üîµ Is same element?', addBottleBtn === document.getElementById('addBottleBtn'));
    
    addBottleBtn.addEventListener('click', () => {
      console.log('üîµ Add bottle button clicked!');
      openAddModal();
    });

    const setViewMode = (mode) => {
      viewMode = mode;
      if (gridViewBtn && listViewBtn) {
        gridViewBtn.classList.toggle('active', mode === 'grid');
        listViewBtn.classList.toggle('active', mode === 'list');
      }
      renderBottles();
    };

    if (gridViewBtn && listViewBtn) {
      gridViewBtn.addEventListener('click', () => setViewMode('grid'));
      listViewBtn.addEventListener('click', () => setViewMode('list'));
    }
    
    // Verify event listener was added
    console.log('üîµ Event listener added to button');
    document.getElementById('bottleModalCancel').addEventListener('click', closeBottleModal);
    document.getElementById('bottleBaseSpirit').addEventListener('change', updateCategoryDropdown);
    bottleForm.addEventListener('submit', submitBottle);
    
    document.getElementById('deleteModalCancel').addEventListener('click', closeDeleteModal);
    deleteConfirmBtn.addEventListener('click', confirmDelete);
    
    // Panel switching handlers
    scanBarcodeBtn.addEventListener('click', showUpcPanel);
    upcBackBtn.addEventListener('click', showFormPanel);
    upcCancelBtn.addEventListener('click', () => {
      showFormPanel();
      upcInput.value = '';
      barcodeLookupStatus.style.display = 'none';
    });
    barcodeForm.addEventListener('submit', lookupBarcode);
    
    // Image upload handlers
    imageUploadPlaceholder?.addEventListener('click', () => bottleImage?.click());
    bottleImage?.addEventListener('change', onImageSelected);
    clearImageBtn?.addEventListener('click', clearImageFile);
    
    // Close modals on overlay click
    bottleModal.addEventListener('click', (e) => {
      if (e.target === bottleModal) closeBottleModal();
    });
    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) closeDeleteModal();
    });
    
    // Image selector modal
    const imageSelectOverlay = document.getElementById('imageSelectOverlay');
    const imageSelectCancel = document.getElementById('imageSelectCancel');
    if (imageSelectCancel) {
      imageSelectCancel.addEventListener('click', closeImageSelector);
    }
    if (imageSelectOverlay) {
      imageSelectOverlay.addEventListener('click', (e) => {
        if (e.target === imageSelectOverlay) closeImageSelector();
      });
    }
    
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    if (closePreviewBtn) {
      closePreviewBtn.addEventListener('click', () => {
        imagePreviewOverlay.classList.remove('active');
      });
    }
    imagePreviewOverlay.addEventListener('click', (e) => {
      if (e.target === imagePreviewOverlay) {
        imagePreviewOverlay.classList.remove('active');
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && imagePreviewOverlay.classList.contains('active')) {
        imagePreviewOverlay.classList.remove('active');
      }
    });

    // Initial load
    loadBottles();
  }
  
  // Run init immediately (SPA already has DOM ready)
  init();
})();
</script>
