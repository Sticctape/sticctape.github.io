<div class="inventory-wrap">
  <!-- Header controls -->
  <div class="inventory-header">
    <div class="inventory-search-row">
      <div class="view-toggle" aria-label="Inventory view mode">
        <button id="gridViewBtn" class="view-btn active" type="button" aria-label="Grid view">
          <span class="icon-grid" aria-hidden="true"></span>
        </button>
        <button id="listViewBtn" class="view-btn" type="button" aria-label="List view">
          <span class="icon-list" aria-hidden="true"></span>
        </button>
      </div>
      <input 
        type="text" 
        id="inventorySearch" 
        class="inventory-search" 
        placeholder="Search by bottle name..."
      />
      <button id="addBottleBtn" class="filter-reset-btn is-hidden" type="button">+ Add Bottle</button>
    </div>
    
    <div class="inventory-filters">
      <!-- Base Spirits Filter -->
      <div class="filter-group">
        <label class="filter-label">Base Spirits:</label>
        <div class="filter-pills" id="baseSpiritFilters">
          <button class="filter-pill active" data-spirit="all">All</button>
          <button class="filter-pill" data-spirit="bourbon">Bourbon</button>
          <button class="filter-pill" data-spirit="whiskey">Whiskey</button>
          <button class="filter-pill" data-spirit="rye">Rye</button>
          <button class="filter-pill" data-spirit="scotch">Scotch</button>
          <button class="filter-pill" data-spirit="rum">Rum</button>
          <button class="filter-pill" data-spirit="gin">Gin</button>
          <button class="filter-pill" data-spirit="vodka">Vodka</button>
          <button class="filter-pill" data-spirit="tequila">Tequila</button>
          <button class="filter-pill" data-spirit="mezcal">Mezcal</button>
          <button class="filter-pill" data-spirit="brandy">Brandy</button>
          <button class="filter-pill" data-spirit="cognac">Cognac</button>
        </div>
      </div>
      
      <!-- Mixers/Modifiers Filter -->
      <div class="filter-group">
        <label class="filter-label">Mixers & Modifiers:</label>
        <div class="filter-pills" id="mixerFilters">
          <button class="filter-pill active" data-mixer="all">All</button>
          <button class="filter-pill" data-mixer="liqueur">Liqueur</button>
          <button class="filter-pill" data-mixer="coffeeliqueur">Coffee Liqueur</button>
          <button class="filter-pill" data-mixer="amaro">Amaro</button>
          <button class="filter-pill" data-mixer="vermouth">Vermouth</button>
          <button class="filter-pill" data-mixer="bitters">Bitters</button>
          <button class="filter-pill" data-mixer="syrup">Syrup</button>
          <button class="filter-pill" data-mixer="foam">Foam</button>
          <button class="filter-pill" data-mixer="cordial">Cordial</button>
          <button class="filter-pill" data-mixer="other">Other</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottle Grid -->
  <div id="bottleGrid" class="bottle-grid">
    <!-- Populated by JS -->
  </div>
  
  <div id="emptyState" class="inventory-empty is-hidden">
    <p>No bottles found. <span id="addBottlePrompt" class="is-hidden">Add your first bottle to get started!</span></p>
  </div>
</div>

<!-- Add/Edit Bottle Modal -->
<div class="modal-overlay" id="bottleModalOverlay">
  <div class="modal bottle-modal">
    <div class="modal-header">
      <h2 id="bottleModalTitle">Add Bottle</h2>
    </div>
    <div class="modal-body">
      <form id="bottleForm">
        <input type="hidden" id="bottleId" />
        
        <div class="form-row">
          <div class="form-group">
            <label for="bottleBrand">Brand *</label>
            <input type="text" id="bottleBrand" required />
          </div>
          <div class="form-group">
            <label for="bottleProduct">Product Name *</label>
            <input type="text" id="bottleProduct" required />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="bottleBaseSpirit">Base Spirit *</label>
            <select id="bottleBaseSpirit" required>
              <option value="">Select...</option>
              <option value="bourbon">Bourbon</option>
              <option value="whiskey">Whiskey</option>
              <option value="rye">Rye</option>
              <option value="scotch">Scotch</option>
              <option value="rum">Rum</option>
              <option value="gin">Gin</option>
              <option value="vodka">Vodka</option>
              <option value="tequila">Tequila</option>
              <option value="mezcal">Mezcal</option>
              <option value="brandy">Brandy</option>
              <option value="cognac">Cognac</option>
              <option value="liqueur">Liqueur</option>
              <option value="coffeeliqueur">Coffee Liqueur</option>
              <option value="amaro">Amaro</option>
              <option value="vermouth">Vermouth</option>
              <option value="bitters">Bitters</option>
              <option value="syrup">Syrup</option>
              <option value="foam">Foam</option>
              <option value="cordial">Cordial</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="bottleStyle">Style/Type</label>
            <input type="text" id="bottleStyle" placeholder="e.g. Single Malt, Spiced, London Dry" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="bottleABV">ABV %</label>
            <input type="number" id="bottleABV" step="0.1" min="0" max="100" />
          </div>
          <div class="form-group">
            <label for="bottleVolume">Volume (ml)</label>
            <input type="number" id="bottleVolume" step="1" min="0" />
          </div>
          <div class="form-group">
            <label for="bottleQuantity">Quantity *</label>
            <input type="number" id="bottleQuantity" step="1" min="0" value="1" required />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="bottlePrice">Price</label>
            <input type="number" id="bottlePrice" step="0.01" min="0" placeholder="USD" />
          </div>
          <div class="form-group">
            <label for="bottlePurchaseDate">Purchase Date</label>
            <input type="date" id="bottlePurchaseDate" />
          </div>
        </div>
        
        <div class="form-group">
          <label for="bottleLocation">Location</label>
          <input type="text" id="bottleLocation" placeholder="e.g. Top shelf, Cabinet A" />
        </div>
        
        <div class="form-group">
          <label for="bottleTags">Tags (comma-separated)</label>
          <input type="text" id="bottleTags" placeholder="e.g. favorite, gift, rare" />
        </div>
        
        <div class="form-group">
          <label for="bottleNotes">Notes</label>
          <textarea id="bottleNotes" rows="3" placeholder="Tasting notes, pairing suggestions, etc."></textarea>
        </div>
        
        <div class="form-actions">
          <button type="button" id="scanBarcodeBtn" class="scan-barcode-btn">üì∑ Scan Barcode</button>
          <div class="form-actions-right">
            <button type="button" class="cancel-btn" id="bottleModalCancel">Cancel</button>
            <button type="submit" class="submit-btn">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModalOverlay">
  <div class="modal delete-modal">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
    </div>
    <div class="modal-body">
      <p id="deleteMessage">Are you sure you want to remove this bottle from inventory?</p>
      <div class="form-actions">
        <button type="button" class="cancel-btn" id="deleteModalCancel">Cancel</button>
        <button type="button" class="delete-btn" id="deleteModalConfirm">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Image Preview Modal (inventory) -->
<div class="modal-overlay" id="imagePreviewOverlay">
  <div class="modal image-preview-modal">
    <div class="modal-body">
      <div class="preview-details">
        <h3 id="previewTitle"></h3>
        <ul class="preview-fields">
          <li><strong>Base Spirit:</strong> <span id="previewBaseSpirit"></span></li>
          <li><strong>Style:</strong> <span id="previewStyle"></span></li>
          <li><strong>ABV:</strong> <span id="previewABV"></span></li>
          <li><strong>Volume:</strong> <span id="previewVolume"></span></li>
          <li><strong>Quantity:</strong> <span id="previewQuantity"></span></li>
          <li><strong>Price:</strong> <span id="previewPrice"></span></li>
          <li><strong>Purchase Date:</strong> <span id="previewPurchase"></span></li>
          <li><strong>Location:</strong> <span id="previewLocation"></span></li>
          <li><strong>Tags:</strong> <span id="previewTags"></span></li>
        </ul>
        <div class="preview-notes" id="previewNotes"></div>
      </div>
      <div class="preview-image-wrap">
        <img id="imagePreviewImg" alt="Bottle image preview" />
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="close-btn" id="closePreviewBtn">Close</button>
    </div>
  </div>
  </div>

<script>
(() => {
  console.log('üîµ Inventory script starting...');
  
  const API_BASE = 'https://bar.streeter.cc/api';
  const API_ADMIN = 'https://bar.streeter.cc/api/admin';
  
  // Local dev mode disabled so localhost uses the real API (CF Access removed)
  const LOCAL_DEV_MODE = false;
  console.log('üîµ LOCAL_DEV_MODE:', LOCAL_DEV_MODE, 'hostname:', window.location.hostname);
  
  let allBottles = [];
  let isOwner = false;
  let viewMode = 'grid';
  let currentFilters = {
    search: '',
    selectedTypes: new Set()
  };
  let editingBottleId = null;
  let deletingBottleId = null;

  // Helper to get auth headers (include owner or staff token if present)
  function getAuthHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    const ownerToken = localStorage.getItem('ownerToken');
    const staffToken = localStorage.getItem('staffToken');
    const token = ownerToken || staffToken;
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
      console.log('üîµ Adding auth token to request');
      console.log('üîµ Token type:', ownerToken ? 'owner' : 'staff');
      console.log('üîµ Token first 20 chars:', token.slice(0, 20) + '...');
      console.log('üîµ Starts with owner_:', token.startsWith('owner_'));
      console.log('üîµ Starts with staff_:', token.startsWith('staff_'));
    } else {
      console.log('üîµ No owner or staff token found in localStorage');
    }
    return headers;
  }

  // Wait for DOM to be ready
  function init() {
    console.log('üîµ Init function called');
    
    // DOM elements
    const bottleGrid = document.getElementById('bottleGrid');
    const emptyState = document.getElementById('emptyState');
    const addBottlePrompt = document.getElementById('addBottlePrompt');
    const searchInput = document.getElementById('inventorySearch');
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const addBottleBtn = document.getElementById('addBottleBtn');
    const baseSpiritFilters = document.getElementById('baseSpiritFilters');
    const mixerFilters = document.getElementById('mixerFilters');
    
    const bottleModal = document.getElementById('bottleModalOverlay');
    const bottleModalTitle = document.getElementById('bottleModalTitle');
    const bottleForm = document.getElementById('bottleForm');
    const scanBarcodeBtn = document.getElementById('scanBarcodeBtn');
    
    const deleteModal = document.getElementById('deleteModalOverlay');
    const deleteMessage = document.getElementById('deleteMessage');
    const deleteConfirmBtn = document.getElementById('deleteModalConfirm');
    const imagePreviewOverlay = document.getElementById('imagePreviewOverlay');
    const imagePreviewImg = document.getElementById('imagePreviewImg');
    const previewTitle = document.getElementById('previewTitle');
    const previewBaseSpirit = document.getElementById('previewBaseSpirit');
    const previewStyle = document.getElementById('previewStyle');
    const previewABV = document.getElementById('previewABV');
    const previewVolume = document.getElementById('previewVolume');
    const previewQuantity = document.getElementById('previewQuantity');
    const previewPrice = document.getElementById('previewPrice');
    const previewPurchase = document.getElementById('previewPurchase');
    const previewLocation = document.getElementById('previewLocation');
    const previewTags = document.getElementById('previewTags');
    const previewNotes = document.getElementById('previewNotes');
    
    console.log('üîµ DOM elements found:', {
      bottleGrid: !!bottleGrid,
      addBottleBtn: !!addBottleBtn,
      searchInput: !!searchInput,
      gridViewBtn: !!gridViewBtn,
      listViewBtn: !!listViewBtn,
      baseSpiritFilters: !!baseSpiritFilters
    });
    
    if (!bottleGrid || !addBottleBtn) {
      console.warn('‚ö†Ô∏è Required DOM elements not found, retrying...');
      setTimeout(init, 50); // Retry after a short delay
      return;
    }
    
    console.log('‚úÖ All DOM elements ready, setting up...');

    // Ensure modals are top-level so z-index can outrank navbar
    try {
      if (bottleModal && bottleModal.parentElement !== document.body) {
        document.body.appendChild(bottleModal);
        console.log('üîß Moved bottleModalOverlay to <body>');
      }
      if (deleteModal && deleteModal.parentElement !== document.body) {
        document.body.appendChild(deleteModal);
        console.log('üîß Moved deleteModalOverlay to <body>');
      }
      if (imagePreviewOverlay && imagePreviewOverlay.parentElement !== document.body) {
        document.body.appendChild(imagePreviewOverlay);
        console.log('üîß Moved imagePreviewOverlay to <body>');
      }
    } catch (moveErr) {
      console.warn('‚ö†Ô∏è Could not move modals to body:', moveErr);
    }

    // Delegate bottle card action buttons so clicks survive re-renders
    bottleGrid.addEventListener('click', (e) => {
      // Check for owner-only buttons first (higher priority)
      if (isOwner) {
        const editBtn = e.target.closest('.edit-bottle-btn');
        if (editBtn) {
          e.preventDefault();
          e.stopPropagation();
          openEditModal(editBtn.dataset.id);
          return;
        }
        const deleteBtn = e.target.closest('.delete-bottle-btn');
        if (deleteBtn) {
          e.preventDefault();
          e.stopPropagation();
          openDeleteModal(deleteBtn.dataset.id);
          return;
        }
      }
      
      // Image preview modal for entire card (unless clicking action buttons)
      const card = e.target.closest('article.bottle-card');
      if (card) {
        e.preventDefault();
        e.stopPropagation();
        const id = card.getAttribute('data-id');
        const bottle = id ? allBottles.find(b => String(b.id) === String(id)) : null;
        const imgEl = card.querySelector('img');
        if (imagePreviewImg && imgEl) imagePreviewImg.src = imgEl.src;
        if (bottle) {
          if (previewTitle) previewTitle.textContent = `${bottle.brand || ''} ${bottle.product_name || ''}`.trim();
          if (previewBaseSpirit) previewBaseSpirit.textContent = bottle.base_spirit || '';
          if (previewStyle) previewStyle.textContent = bottle.style || '';
          if (previewABV) previewABV.textContent = (typeof bottle.abv === 'number' ? `${bottle.abv}%` : (bottle.abv || ''));
          if (previewVolume) previewVolume.textContent = bottle.volume_ml ? `${bottle.volume_ml} ml` : '';
          if (previewQuantity) previewQuantity.textContent = String(bottle.quantity ?? '');
          if (previewPrice) previewPrice.textContent = (typeof bottle.price_cents === 'number') ? `$${(bottle.price_cents/100).toFixed(2)} ${bottle.currency || 'USD'}` : '';
          if (previewPurchase) previewPurchase.textContent = bottle.purchase_date || '';
          if (previewLocation) previewLocation.textContent = bottle.location || '';
          if (previewTags) previewTags.textContent = Array.isArray(bottle.tags) ? bottle.tags.join(', ') : '';
          if (previewNotes) previewNotes.textContent = bottle.notes || '';
        } else {
          if (previewTitle) previewTitle.textContent = '';
          if (previewBaseSpirit) previewBaseSpirit.textContent = '';
          if (previewStyle) previewStyle.textContent = '';
          if (previewABV) previewABV.textContent = '';
          if (previewVolume) previewVolume.textContent = '';
          if (previewQuantity) previewQuantity.textContent = '';
          if (previewPrice) previewPrice.textContent = '';
          if (previewPurchase) previewPurchase.textContent = '';
          if (previewLocation) previewLocation.textContent = '';
          if (previewTags) previewTags.textContent = '';
          if (previewNotes) previewNotes.textContent = '';
        }
        imagePreviewOverlay.classList.add('active');
        return;
      }
    });
  
    // Placeholder images based on spirit type
    const spiritPlaceholders = {
      bourbon: 'assets/bottles/whiskey.png',
      whiskey: 'assets/bottles/whiskey.png',
      rye: 'assets/bottles/whiskey.png',
      scotch: 'assets/bottles/scotch.png',
      rum: 'assets/bottles/rum.png',
      gin: 'assets/bottles/gin.png',
      vodka: 'assets/bottles/vodka.png',
      tequila: 'assets/bottles/whiskey.png',
      mezcal: 'assets/bottles/whiskey.png',
      brandy: 'assets/bottles/whiskey.png',
      cognac: 'assets/bottles/whiskey.png',
      liqueur: 'assets/bottles/whiskey.png',
      coffeeliqueur: 'assets/bottles/whiskey.png',
      amaro: 'assets/bottles/whiskey.png',
      vermouth: 'assets/bottles/whiskey.png',
      bitters: 'assets/bottles/whiskey.png',
      syrup: 'assets/bottles/whiskey.png',
      foam: 'assets/bottles/whiskey.png',
      cordial: 'assets/bottles/whiskey.png',
      other: 'assets/bottles/whiskey.png'
    };

    // Load bottles from API
    async function loadBottles() {
      console.log('üîµ loadBottles called, LOCAL_DEV_MODE:', LOCAL_DEV_MODE);
      try {
        // In local dev mode, enable owner features and use empty inventory
        if (LOCAL_DEV_MODE) {
          console.log('üîß Local dev mode: Owner features enabled');
          isOwner = true;
          console.log('üîµ Removing is-hidden from addBottleBtn');
          console.log('üîµ Button before:', addBottleBtn.classList.toString());
          addBottleBtn.classList.remove('is-hidden');
          console.log('üîµ Button after:', addBottleBtn.classList.toString());
          console.log('üîµ Button display:', window.getComputedStyle(addBottleBtn).display);
          console.log('üîµ Button visibility:', window.getComputedStyle(addBottleBtn).visibility);
          addBottlePrompt.classList.remove('is-hidden');
          allBottles = [];
          console.log('üîµ About to call renderBottles');
          renderBottles();
          console.log('üîµ After renderBottles, button classes:', addBottleBtn.classList.toString());
          return;
        }
      
      console.log('üîµ Not local dev, fetching from API...');
      
      // Check if user is owner (from login)
      const isOwnerLoggedIn = localStorage.getItem('isOwner') === 'true';
      if (isOwnerLoggedIn) {
        console.log('‚úÖ Authenticated as OWNER');
        isOwner = true;
        addBottleBtn.classList.remove('is-hidden');
        addBottlePrompt.classList.remove('is-hidden');
      } else {
        console.log('‚úÖ Authenticated as STAFF (read-only)');
        isOwner = false;
      }
      
      // Fetch bottles
      const resp = await fetch(`${API_BASE}/bottles`, {
        headers: getAuthHeaders(),
        credentials: 'include',
        mode: 'cors'
      });
      
      if (!resp.ok) {
        throw new Error(`Failed to load bottles: ${resp.statusText}`);
      }
      
      const data = await resp.json();
      allBottles = data.bottles || [];
      renderBottles();
    } catch (err) {
      console.error('Error loading bottles:', err);
      bottleGrid.innerHTML = '<p style="text-align:center;color:#f66;padding:2rem;">Failed to load inventory. Please try again.</p>';
    }
    }

    // Expand selected types to handle hierarchy (e.g., whiskey ‚Üí bourbon+rye+whiskey)
    function expandSelectedTypes(selected) {
      const expanded = new Set(selected);
      if (selected.has('whiskey')) {
        expanded.add('whiskey');
        expanded.add('bourbon');
        expanded.add('rye');
      }
      // Add other hierarchical relationships here if desired
      // For now, scotch remains its own category.
      return expanded;
    }

    // Filter bottles based on current filters
    function getFilteredBottles() {
    const hasTypeFilters = currentFilters.selectedTypes && currentFilters.selectedTypes.size > 0;
    const expandedTypes = hasTypeFilters ? expandSelectedTypes(currentFilters.selectedTypes) : null;
    return allBottles.filter(bottle => {
      // Search filter (substring match on brand + product)
      if (currentFilters.search) {
        const searchLower = currentFilters.search.toLowerCase();
        const brandMatch = (bottle.brand || '').toLowerCase().includes(searchLower);
        const productMatch = (bottle.product_name || '').toLowerCase().includes(searchLower);
        if (!brandMatch && !productMatch) return false;
      }
      
      // Type filters (union of base spirits + mixers) with hierarchy
      if (hasTypeFilters) {
        const t = (bottle.base_spirit || '').toLowerCase();
        if (!expandedTypes.has(t)) return false;
      }
      
      return true;
      });
    }

    // Render bottles to grid
    function renderBottles() {
    bottleGrid.classList.toggle('list-view', viewMode === 'list');
    const filtered = getFilteredBottles();
    
    if (filtered.length === 0) {
      bottleGrid.innerHTML = '';
      emptyState.classList.remove('is-hidden');
      return;
    }
    
    emptyState.classList.add('is-hidden');
    bottleGrid.innerHTML = filtered.map(bottle => {
      const placeholder = spiritPlaceholders[bottle.base_spirit?.toLowerCase()] || spiritPlaceholders.other;
      const imageSrc = bottle.image_url || placeholder;
      
      const isPlaceholder = !bottle.image_url;
      return `
        <article class="bottle-card" data-id="${bottle.id}">
          <img class="${isPlaceholder ? 'placeholder-img' : ''}" src="${imageSrc}" alt="${bottle.brand} ${bottle.product_name}" />
          <div class="bottle-info">
            <div class="bottle-title">
              <h3>${bottle.brand || 'Unknown'}</h3>
              <p class="bottle-product">${bottle.product_name || ''}</p>
            </div>
            <div class="bottle-meta">
              <p class="bottle-details">
                <span class="bottle-spirit">${bottle.base_spirit || ''}</span>
                ${bottle.volume_ml ? `<span class="bottle-volume">${bottle.volume_ml}ml</span>` : ''}
              </p>
              ${bottle.location ? `<p class="bottle-location">üìç ${bottle.location}</p>` : ''}
              <p class="bottle-quantity">Qty: ${bottle.quantity || 0}</p>
            </div>
          </div>
          ${isOwner ? `
            <div class="bottle-actions">
              <button class="edit-bottle-btn" data-id="${bottle.id}">Edit</button>
              <button class="delete-bottle-btn" data-id="${bottle.id}">Delete</button>
            </div>
          ` : ''}
        </article>
      `;
    }).join('');
    }

    // Open add modal
    function openAddModal() {
      console.log('üîµ openAddModal called');
      editingBottleId = null;
      bottleModalTitle.textContent = 'Add Bottle';
      bottleForm.reset();
      document.getElementById('bottleId').value = '';
      console.log('üîµ Adding active class to modal');
      bottleModal.classList.add('active');
      console.log('üîµ Modal classes:', bottleModal.className);
    }

    // Open edit modal
    function openEditModal(id) {
      const bottle = allBottles.find(b => String(b.id) === String(id));
      if (!bottle) return;
      
      editingBottleId = id;
      bottleModalTitle.textContent = 'Edit Bottle';
      
      document.getElementById('bottleId').value = bottle.id;
      document.getElementById('bottleBrand').value = bottle.brand || '';
      document.getElementById('bottleProduct').value = bottle.product_name || '';
    document.getElementById('bottleBaseSpirit').value = bottle.base_spirit || '';
    document.getElementById('bottleStyle').value = bottle.style || '';
    document.getElementById('bottleABV').value = bottle.abv || '';
    document.getElementById('bottleVolume').value = bottle.volume_ml || '';
    document.getElementById('bottleQuantity').value = bottle.quantity || 1;
    document.getElementById('bottlePrice').value = bottle.price_cents ? (bottle.price_cents / 100).toFixed(2) : '';
    document.getElementById('bottlePurchaseDate').value = bottle.purchase_date || '';
    document.getElementById('bottleLocation').value = bottle.location || '';
      document.getElementById('bottleTags').value = Array.isArray(bottle.tags) ? bottle.tags.join(', ') : '';
      document.getElementById('bottleNotes').value = bottle.notes || '';
      
      bottleModal.classList.add('active');
    }

    // Close modals
    function closeBottleModal() {
      bottleModal.classList.remove('active');
      editingBottleId = null;
    }

    function closeDeleteModal() {
      deleteModal.classList.remove('active');
      deletingBottleId = null;
    }

    // Submit bottle form
    async function submitBottle(e) {
      e.preventDefault();
      
      const formData = {
        brand: document.getElementById('bottleBrand').value.trim(),
        product_name: document.getElementById('bottleProduct').value.trim(),
        base_spirit: document.getElementById('bottleBaseSpirit').value,
        style: document.getElementById('bottleStyle').value.trim() || null,
        abv: parseFloat(document.getElementById('bottleABV').value) || null,
        volume_ml: parseInt(document.getElementById('bottleVolume').value) || null,
        quantity: parseInt(document.getElementById('bottleQuantity').value) || 1,
        price_cents: document.getElementById('bottlePrice').value ? Math.round(parseFloat(document.getElementById('bottlePrice').value) * 100) : null,
        currency: document.getElementById('bottlePrice').value ? 'USD' : null,
        purchase_date: document.getElementById('bottlePurchaseDate').value || null,
        location: document.getElementById('bottleLocation').value.trim() || null,
        notes: document.getElementById('bottleNotes').value.trim() || null,
        tags: document.getElementById('bottleTags').value
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0)
      };
      
      try {
        // Local dev mode: Simulate adding to local array
        if (LOCAL_DEV_MODE) {
          if (editingBottleId !== null) {
            const index = allBottles.findIndex(b => String(b.id) === String(editingBottleId));
            if (index !== -1) {
              allBottles[index] = { ...allBottles[index], ...formData };
            }
          } else {
            const newBottle = {
              id: Date.now(),
              ...formData,
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString()
            };
            allBottles.push(newBottle);
          }
          closeBottleModal();
          renderBottles();
          return;
        }
        
        const url = editingBottleId ? `${API_ADMIN}/bottles/${editingBottleId}` : `${API_ADMIN}/bottles`;
        const method = editingBottleId ? 'PUT' : 'POST';
        
        console.log('üîµ Saving bottle:', { method, url, formData });
        const resp = await fetch(url, {
          method,
          headers: getAuthHeaders(),
          body: JSON.stringify(formData),
          credentials: 'include',
          mode: 'cors'
        });
        
        if (!resp.ok) {
          let errMsg = `HTTP ${resp.status} ${resp.statusText}`;
          try {
            const ct = resp.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
              const err = await resp.json();
              errMsg = err.error || errMsg;
            } else {
              const txt = await resp.text();
              errMsg = txt?.slice(0, 300) || errMsg;
            }
          } catch {}
          throw new Error(errMsg);
        }
        
        closeBottleModal();
        await loadBottles();
      } catch (err) {
        console.error('‚õî Error saving bottle (network/CORS/auth?):', err);
        const hint = 'If this says Failed to fetch, check: 1) Logged into CF Access at /api/admin/auth/check, 2) Worker route for /api/admin/* exists, 3) CORS allows https://streeter.cc';
        alert(`Failed to save bottle: ${err.message || err}.\n${hint}`);
      }
    }

    // Open delete modal
    function openDeleteModal(id) {
      const bottle = allBottles.find(b => String(b.id) === String(id));
      if (!bottle) return;
      
      deletingBottleId = id;
      deleteMessage.textContent = `Are you sure you want to remove ${bottle.brand} ${bottle.product_name} from inventory?`;
      deleteModal.classList.add('active');
    }

    // Confirm delete
    async function confirmDelete() {
      if (!deletingBottleId) return;
      
      try {
        // Local dev mode: Remove from local array
        if (LOCAL_DEV_MODE) {
          allBottles = allBottles.filter(b => String(b.id) !== String(deletingBottleId));
          closeDeleteModal();
          renderBottles();
          return;
        }
        
        const resp = await fetch(`${API_ADMIN}/bottles/${deletingBottleId}`, {
          method: 'DELETE',
        headers: getAuthHeaders(),
        });
        
        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.error || 'Failed to delete bottle');
        }
        
        closeDeleteModal();
        await loadBottles();
      } catch (err) {
        console.error('Error deleting bottle:', err);
        alert(`Failed to delete bottle: ${err.message}`);
      }
    }

    // Search handler
    searchInput.addEventListener('input', (e) => {
      currentFilters.search = e.target.value.trim();
      renderBottles();
    });

    // Filter handlers (multi-select)
    function setAllActive(groupEl, allAttr) {
      groupEl.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
      const allBtn = groupEl.querySelector(allAttr);
      if (allBtn) allBtn.classList.add('active');
    }

    function clearAllSelections() {
      currentFilters.selectedTypes.clear();
      setAllActive(baseSpiritFilters, '[data-spirit="all"]');
      setAllActive(mixerFilters, '[data-mixer="all"]');
    }

    function toggleTypeSelection(type, groupEl, allSelector) {
      // Remove 'All' active when selecting a specific type
      const allBtn = groupEl.querySelector(allSelector);
      if (allBtn) allBtn.classList.remove('active');

      // Find the button for this type in the group
      const btn = Array.from(groupEl.querySelectorAll('.filter-pill')).find(p => (p.dataset.spirit || p.dataset.mixer) === type);
      const willActivate = !(btn && btn.classList.contains('active'));

      if (btn) btn.classList.toggle('active', willActivate);
      if (willActivate) currentFilters.selectedTypes.add(type);
      else currentFilters.selectedTypes.delete(type);

      // If no types selected at all, revert to All on both groups
      if (currentFilters.selectedTypes.size === 0) {
        setAllActive(baseSpiritFilters, '[data-spirit="all"]');
        setAllActive(mixerFilters, '[data-mixer="all"]');
      }
    }

    baseSpiritFilters.addEventListener('click', (e) => {
      if (!e.target.classList.contains('filter-pill')) return;
      e.preventDefault();
      e.stopPropagation();
      const val = e.target.dataset.spirit;
      if (!val) return;
      if (val === 'all') {
        clearAllSelections();
      } else {
        toggleTypeSelection(val, baseSpiritFilters, '[data-spirit="all"]');
      }
      renderBottles();
    });

    mixerFilters.addEventListener('click', (e) => {
      if (!e.target.classList.contains('filter-pill')) return;
      e.preventDefault();
      e.stopPropagation();
      const val = e.target.dataset.mixer;
      if (!val) return;
      if (val === 'all') {
        clearAllSelections();
      } else {
        toggleTypeSelection(val, mixerFilters, '[data-mixer="all"]');
      }
      renderBottles();
    });

    // Modal event listeners
    console.log('üîµ Setting up event listeners...');
    console.log('üîµ addBottleBtn element:', addBottleBtn);
    console.log('üîµ addBottleBtn id:', addBottleBtn.id);
    console.log('üîµ Is same element?', addBottleBtn === document.getElementById('addBottleBtn'));
    
    addBottleBtn.addEventListener('click', () => {
      console.log('üîµ Add bottle button clicked!');
      openAddModal();
    });

    const setViewMode = (mode) => {
      viewMode = mode;
      if (gridViewBtn && listViewBtn) {
        gridViewBtn.classList.toggle('active', mode === 'grid');
        listViewBtn.classList.toggle('active', mode === 'list');
      }
      renderBottles();
    };

    if (gridViewBtn && listViewBtn) {
      gridViewBtn.addEventListener('click', () => setViewMode('grid'));
      listViewBtn.addEventListener('click', () => setViewMode('list'));
    }
    
    // Verify event listener was added
    console.log('üîµ Event listener added to button');
    document.getElementById('bottleModalCancel').addEventListener('click', closeBottleModal);
    bottleForm.addEventListener('submit', submitBottle);
    
    document.getElementById('deleteModalCancel').addEventListener('click', closeDeleteModal);
    deleteConfirmBtn.addEventListener('click', confirmDelete);
    
    // Scan barcode button (placeholder for future)
    scanBarcodeBtn.addEventListener('click', () => {
      alert('Barcode scanning will be implemented soon! This will allow you to scan bottle barcodes and auto-populate details from sites like MegaBev or Total Wine.');
    });

    // Close modals on overlay click
    bottleModal.addEventListener('click', (e) => {
      if (e.target === bottleModal) closeBottleModal();
    });
    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) closeDeleteModal();
    });
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    if (closePreviewBtn) {
      closePreviewBtn.addEventListener('click', () => {
        imagePreviewOverlay.classList.remove('active');
      });
    }
    imagePreviewOverlay.addEventListener('click', (e) => {
      if (e.target === imagePreviewOverlay) {
        imagePreviewOverlay.classList.remove('active');
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && imagePreviewOverlay.classList.contains('active')) {
        imagePreviewOverlay.classList.remove('active');
      }
    });

    // Initial load
    loadBottles();
  }
  
  // Run init immediately (SPA already has DOM ready)
  init();
})();
</script>
