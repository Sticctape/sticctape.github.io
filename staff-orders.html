<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Streeters</title>

  <!-- Fonts + global styles -->
  <link rel="icon" href="/assets/100px_thestreeters.png" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#2a2a2a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Streeters" />
  <link rel="apple-touch-icon" href="/assets/100px_thestreeters.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/site.css" />
</head>
<body>
  <!-- HERO -->
    <header class="hero">
        <a href="/" style="text-decoration:none;">
            <img id="siteHeroBig" src="/assets/thestreeters.png" alt="The Streeters">
        </a>
    </header>

  <!-- NAVBAR -->
<div id="nav-sentinel" style="height:1px;"></div>
  <nav class="site-nav">
    <div class="nav-left-hero">
        <a href="/" style="text-decoration:none;display:block;pointer-events:auto;">
            <img id="siteHeroSmall" src="/assets/thestreeters.png" alt="The Streeters small">
        </a>
    </div>
    <button class="nav-toggle" aria-expanded="false" aria-label="Menu">
        <span class="burger"></span>
    </button>
    
    <!-- Mobile cart (in static navbar) -->
    <div id="navCartWrapMobile" class="nav-cart-wrap nav-cart-mobile is-hidden" aria-hidden="true">
      <img class="nav-cart" src="/assets/cart.png" alt="Cart">
      <span class="cart-count">0</span>
    </div>
    
    <!-- Centered nav items wrapper -->
    <div class="nav-center">
      <ul>
        <li><a href="/about.html"     data-section="about"     class="active">About</a></li>
        <li><a href="/contact.html"   data-section="contact">Contact</a></li>
        <li><a href="/cocktails.html" data-section="cocktails">Cocktails</a></li>
        <li><a href="/inventory.html" data-section="inventory" class="nav-inventory-link is-hidden">Inventory</a></li>
        <li><a href="/staff-orders.html" data-section="staff-orders" class="nav-staff-link is-hidden">Orders</a></li>
        <li class="nav-auth">
          <button id="navLoginBtn" class="nav-login-btn" type="button">Login</button>
          <button id="navLogoutBtn" class="nav-login-btn is-hidden" type="button">Logout</button>
        </li>
        <!-- Desktop cart (in pill) -->
        <li id="navCartWrap" class="nav-cart-wrap nav-cart-desktop is-hidden" aria-hidden="true">
          <img id="navCart" class="nav-cart" src="/assets/cart.png" alt="Cart">
          <span id="cartCount" class="cart-count">0</span>
        </li>
      </ul>
    </div>
  </nav>
  </nav>

  <!-- LOGO & DIVIDER (shown only on Cocktails) -->
  <img id="distLogo"   class="dist-logo"  src="/assets/StreeterDistilleryLogoW.png" alt="Streeter Distillery Logo">
  <div id="logoDivider" class="logo-divider"></div>

  <!-- MAIN -->
  <main id="content">
    <div class="staff-orders-container">
      <h2 class="staff-orders-title">Order Management</h2>
      
      <div class="auto-refresh-toggle">
        <label class="toggle-switch">
          <input type="checkbox" id="autoRefreshToggle">
          <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Auto-refresh every 10 seconds</span>
      </div>
      
      <div id="staffError" class="staff-error is-hidden"></div>
      
      <!-- Status filter -->
      <div class="status-filter-container">
        <span class="status-filter-label">Filter by Status:</span>
        <button class="filter-btn active" data-filter="Received">Received</button>
        <button class="filter-btn active" data-filter="Making">Making</button>
        <button class="filter-btn active" data-filter="Ready">Ready</button>
        <button class="filter-btn active" data-filter="Picked Up">Picked Up</button>
        <button class="filter-reset-btn" id="filterResetBtn">Reset Filters</button>
        <button class="filter-reset-btn" id="deletePickedUpBtn" style="background: rgba(255, 85, 85, 0.15); border-color: rgba(255, 85, 85, 0.3); color: #ff5555;">Delete All Picked Up</button>
      </div>
      
      <table class="staff-orders-table" id="staffOrdersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Drink</th>
            <th>Qty</th>
            <th>Notes</th>
            <th>Status</th>
            <th>Time</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="staffOrdersBody">
          <tr><td colspan="8" class="staff-loading">Loading orders...</td></tr>
        </tbody>
      </table>
    </div>

    <script>
    // Staff orders dashboard logic
    var staffAutoRefresh = false;
    var staffRefreshInterval = null;
    var allOrders = []; // Store all orders for filtering
    var selectedStatusFilters = ['Received', 'Making', 'Ready', 'Picked Up']; // Track selected filters (shows all statuses by default)

    // Abort any previous requests and cleanup
    if (window.staffOrdersController && !window.staffOrdersController.signal.aborted) {
      window.staffOrdersController.abort();
    }

    // Create a fresh controller for this page load
    window.staffOrdersController = new AbortController();
    var staffOrdersController = window.staffOrdersController;

    async function loadStaffOrders() {
      // Reset controller if it was aborted
      if (staffOrdersController.signal.aborted) {
        staffOrdersController = window.staffOrdersController = new AbortController();
      }
      
      const tbody = document.getElementById('staffOrdersBody');
      const errorDiv = document.getElementById('staffError');
      const ownerToken = localStorage.getItem('ownerToken');
      const staffToken = localStorage.getItem('staffToken');
      const token = ownerToken || staffToken;
      
      try {
        if (!tbody || !errorDiv) {
          // Page elements not found (page was navigated away)
          return;
        }
        
        if (!token) {
          throw new Error("Not logged in - please log in on the main page first");
        }
        
        errorDiv.classList.add('is-hidden');
        
        const resp = await fetch('https://streeter.cc/api/all-orders', {
          headers: {
            'X-Staff-Token': token
          },
          signal: staffOrdersController.signal
        });
        
        if (!resp.ok) {
          if (resp.status === 401) throw new Error("Unauthorized - invalid token. Please log in again on the main page.");
          throw new Error(`Server error: ${resp.statusText}`);
        }
        
        const data = await resp.json();
        allOrders = data.orders || [];
        
        // Check if elements still exist
        if (!tbody || !document.body.contains(tbody)) return;
        
        // Render with current filter
        renderFilteredOrders();
        
      } catch (err) {
        // Check if elements still exist (page might have been navigated away)
        if (!errorDiv || !document.body.contains(errorDiv)) return;
        
        // Ignore abort errors (expected when navigating away)
        if (err.name === 'AbortError') return;
        
        errorDiv.textContent = `Error loading orders: ${err.message}`;
        errorDiv.classList.remove('is-hidden');
        
        const tbody = document.getElementById('staffOrdersBody');
        if (tbody && document.body.contains(tbody)) {
          tbody.innerHTML = '<tr><td colspan="8" class="staff-error">Failed to load orders</td></tr>';
        }
      }
    }

    function renderFilteredOrders() {
      const tbody = document.getElementById('staffOrdersBody');
      if (!tbody) return;
      
      // Filter orders based on selected statuses
      const filteredOrders = selectedStatusFilters.length === 0
        ? []
        : allOrders.filter(order => selectedStatusFilters.includes(order.status));
      
      if (filteredOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="staff-empty">No orders found</td></tr>';
        return;
      }
      
      tbody.innerHTML = filteredOrders.map(order => {
        const statusClass = `status-${order.status.toLowerCase().replace(/\s+/g, '-')}`;
        const createdAt = new Date(order.createdAt);
        const timeStr = createdAt.toLocaleString('en-US', { 
          month: '2-digit', 
          day: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: true,
          timeZone: 'America/New_York'
        });
        
        return `
          <tr>
            <td><strong>${order.orderId}</strong></td>
            <td>${order.name}</td>
            <td>${order.drink}</td>
            <td>${order.qty}</td>
            <td>${order.notes || '—'}</td>
            <td><span class="order-status-badge ${statusClass}">${order.status}</span></td>
            <td style="font-size: 0.85rem;">${timeStr}</td>
            <td>
              <div class="status-buttons">
                ${order.status !== 'Making' ? `<button class="status-btn" data-order-id="${order.orderId}" data-status="Making">Making</button>` : ''}
                ${order.status !== 'Ready' ? `<button class="status-btn" data-order-id="${order.orderId}" data-status="Ready">Ready</button>` : ''}
                ${order.status !== 'Picked Up' ? `<button class="status-btn" data-order-id="${order.orderId}" data-status="Picked Up">Picked Up</button>` : ''}
                ${order.status === 'Picked Up' ? `<button class="delete-btn" data-order-id="${order.orderId}">Delete</button>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      // Add event listeners to all status buttons
      tbody.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const orderId = btn.dataset.orderId;
          const newStatus = btn.dataset.status;
          await updateOrderStatus(orderId, newStatus);
        });
      });

      // Add event listeners to all delete buttons
      tbody.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const orderId = btn.dataset.orderId;
          await deleteStaffOrder(orderId);
        });
      });
    }

    async function updateOrderStatus(orderId, newStatus) {
      // Reset controller if it was aborted
      if (staffOrdersController.signal.aborted) {
        staffOrdersController = window.staffOrdersController = new AbortController();
      }
      
      const ownerToken = localStorage.getItem('ownerToken');
      const staffToken = localStorage.getItem('staffToken');
      const token = ownerToken || staffToken;
      try {
        const resp = await fetch(`https://streeter.cc/api/status/${orderId}/${newStatus}`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Staff-Token': token
          },
          signal: staffOrdersController.signal
        });
        
        if (!resp.ok) throw new Error(`Server error: ${resp.statusText}`);
        
        // Reload table after successful update
        await loadStaffOrders();
      } catch (err) {
        if (err.name === 'AbortError') return;
        
        const errorDiv = document.getElementById('staffError');
        if (errorDiv && document.body.contains(errorDiv)) {
          errorDiv.textContent = `Error updating order: ${err.message}`;
          errorDiv.classList.remove('is-hidden');
        }
      }
    }

    async function deleteStaffOrder(orderId) {
      // Reset controller if it was aborted
      if (staffOrdersController.signal.aborted) {
        staffOrdersController = window.staffOrdersController = new AbortController();
      }
      
      const ownerToken = localStorage.getItem('ownerToken');
      const staffToken = localStorage.getItem('staffToken');
      const token = ownerToken || staffToken;
      try {
        const resp = await fetch(`https://streeter.cc/api/orders/${orderId}`, {
          method: 'DELETE',
          headers: { 
            'Content-Type': 'application/json',
            'X-Staff-Token': token
          },
          signal: staffOrdersController.signal
        });
        
        if (!resp.ok) throw new Error(`Server error: ${resp.statusText}`);
        
        // Reload table after successful deletion
        await loadStaffOrders();
      } catch (err) {
        if (err.name === 'AbortError') return;
        
        const errorDiv = document.getElementById('staffError');
        if (errorDiv && document.body.contains(errorDiv)) {
          errorDiv.textContent = `Error deleting order: ${err.message}`;
          errorDiv.classList.remove('is-hidden');
        }
      }
    }

    async function deleteAllPickedUp() {
      // Reset controller if it was aborted
      if (staffOrdersController.signal.aborted) {
        staffOrdersController = window.staffOrdersController = new AbortController();
      }
      
        const ownerToken = localStorage.getItem('ownerToken');
        const staffToken = localStorage.getItem('staffToken');
        const token = ownerToken || staffToken;
      const pickedUpOrders = allOrders.filter(order => order.status === 'Picked Up');
      
      if (pickedUpOrders.length === 0) {
        const errorDiv = document.getElementById('staffError');
        if (errorDiv && document.body.contains(errorDiv)) {
          errorDiv.textContent = 'No picked up orders to delete';
          errorDiv.classList.remove('is-hidden');
        }
        return;
      }
      
      try {
        // Delete each picked up order
        for (const order of pickedUpOrders) {
          const resp = await fetch(`https://streeter.cc/api/orders/${order.orderId}`, {
            method: 'DELETE',
            headers: { 
              'Content-Type': 'application/json',
                'X-Staff-Token': token
            },
            signal: staffOrdersController.signal
          });
          
          if (!resp.ok) {
            throw new Error(`Failed to delete order ${order.orderId}`);
          }
        }
        
        // Reload table after successful deletion
        await loadStaffOrders();
      } catch (err) {
        if (err.name === 'AbortError') return;
        
        const errorDiv = document.getElementById('staffError');
        if (errorDiv && document.body.contains(errorDiv)) {
          errorDiv.textContent = `Error deleting picked up orders: ${err.message}`;
          errorDiv.classList.remove('is-hidden');
        }
      }
    }

    function startStaffAutoRefresh() {
      if (staffRefreshInterval) clearInterval(staffRefreshInterval);
      staffRefreshInterval = setInterval(loadStaffOrders, 10000); // Refresh every 10 seconds
      loadStaffOrders(); // Initial load
    }

    function stopStaffAutoRefresh() {
      if (staffRefreshInterval) {
        clearInterval(staffRefreshInterval);
        staffRefreshInterval = null;
      }
    }

    function setupFilterButtons() {
      // Convert NodeList to Array to avoid iteration issues when replacing
      const filterBtns = Array.from(document.querySelectorAll('.filter-btn'));
      
      filterBtns.forEach(btn => {
        // Clone to remove old listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        // Sync button state with current filters
        const status = newBtn.dataset.filter;
        if (selectedStatusFilters.includes(status)) {
          newBtn.classList.add('active');
        } else {
          newBtn.classList.remove('active');
        }
        
        newBtn.addEventListener('click', () => {
          // Toggle selection
          if (selectedStatusFilters.includes(status)) {
            selectedStatusFilters = selectedStatusFilters.filter(s => s !== status);
            newBtn.classList.remove('active');
          } else {
            selectedStatusFilters.push(status);
            newBtn.classList.add('active');
          }
          
          // Re-render with new filters
          renderFilteredOrders();
        });
      });
    }

    // Setup reset button
    function setupResetButton() {
      const resetBtn = document.getElementById('filterResetBtn');
      if (resetBtn) {
        // Clone to remove old listeners
        const newResetBtn = resetBtn.cloneNode(true);
        resetBtn.parentNode.replaceChild(newResetBtn, resetBtn);
        
        newResetBtn.addEventListener('click', () => {
          // Reset to default: show all statuses
          selectedStatusFilters = ['Received', 'Making', 'Ready', 'Picked Up'];
          
          // Update button states
          const filterBtns = document.querySelectorAll('.filter-btn');
          filterBtns.forEach(btn => {
            if (selectedStatusFilters.includes(btn.dataset.filter)) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
          
          // Re-render
          renderFilteredOrders();
        });
      }
    }

    function setupDeletePickedUpButton() {
      const deleteBtn = document.getElementById('deletePickedUpBtn');
      if (deleteBtn) {
        // Clone to remove old listeners
        const newDeleteBtn = deleteBtn.cloneNode(true);
        deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
        
        newDeleteBtn.addEventListener('click', async () => {
          await deleteAllPickedUp();
        });
      }
    }

    // Setup filter buttons with a small delay to ensure DOM is ready
    setTimeout(() => {
      setupFilterButtons();
      setupResetButton();
      setupDeletePickedUpButton();
    }, 0);

    // Initial load - fetch orders and render
    loadStaffOrders();

    // Toggle auto-refresh
    var autoRefreshToggle = document.getElementById('autoRefreshToggle');
    if (autoRefreshToggle) {
      // Reset toggle state
      autoRefreshToggle.checked = false;
      
      autoRefreshToggle.addEventListener('change', (e) => {
        staffAutoRefresh = e.target.checked;
        if (staffAutoRefresh) {
          startStaffAutoRefresh();
        } else {
          stopStaffAutoRefresh();
        }
      });
    }

    // No navigation cleanup needed in multi-page mode
    </script>
  </main>

  <!-- Cocktail MODAL -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-main">
          <!-- header stays fixed -->
          <img id="modalImg" alt="">
          <h3 id="modalTitle"></h3>

          <!-- ▼▼ scrollable section ▼▼ -->
              <div class="modal-body">
                  <ul id="modalIngredients"></ul>
                  <div class="divider"></div>
                  <p id="modalInstructions"></p>
                  <div class="divider"></div>
              </div>
          <!-- ▲▲ scrolls ▲▲ -->

            <!-- footer stays fixed -->
          <div class="modal-footer" style="display:flex;gap:8px;justify-content:center;align-items:center;margin-top:12px;">
            <button class="close-btn" id="closeBtn">Close</button>
            <button class="close-btn order-btn is-hidden" id="orderBtn" type="button">Order</button>
          </div>
        </div>

        <!-- Order panel (slides in from right) -->
        <div class="order-panel" id="orderPanel" aria-hidden="true">
          <h3 style="margin-top:0;">Place Order</h3>
          <p style="opacity:.85;">Enter the name for this order:</p>
          <input id="orderName" type="text" placeholder="Name" style="width:100%;margin:12px 0;padding:.5rem;border-radius:.5rem;border:1px solid rgba(255,255,255,.12);background:transparent;color:inherit;">
          <p style="opacity:.85;margin-top:12px;">Notes:</p>
          <textarea id="orderNotes" placeholder="Notes" maxlength="120" style="width:100%;margin:8px 0;padding:.5rem;border-radius:.5rem;border:1px solid rgba(255,255,255,.12);background:transparent;color:inherit;resize:vertical;height:60px;font-family:inherit;"></textarea>
          <p id="noteCount" style="opacity:.6;font-size:.85rem;margin:4px 0 0;text-align:right;">0/120</p>
          <p id="orderError" class="is-hidden" style="color:#f55;margin:0 0 8px;font-size:.9rem"></p>
          <div style="display:flex;gap:8px;width:100%;">
            <button id="cancelOrder" class="close-btn" type="button" style="flex:1;">Cancel</button>
            <button id="submitOrder" class="close-btn" type="button" style="flex:1;">Submit Order</button>
          </div>
        </div>
  </div>
</div>

  <!-- LOGIN MODAL -->
<div class="modal-overlay" id="loginOverlay">
  <div class="modal">
    <h3 style="margin-top:0;">Member Login</h3>

    <form id="loginForm">
      <label style="display:block; margin:12px 0 6px;">Password</label>
      <input id="loginPassword" type="password" autocomplete="current-password" required style="width:100%;">

      <p id="loginError" class="is-hidden" style="margin:10px 0 0; color:#f55;"></p>

      <div style="display:flex; gap:10px; margin-top:14px;">
        <button type="submit" class="close-btn" style="flex:1;">Log in</button>
        <button type="button" class="close-btn" id="loginCloseBtn" style="flex:1;">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Cart flyout panel (slides in from right) -->
<div class="cart-flyout is-hidden" id="cartFlyout" aria-hidden="true">
  <div class="cart-flyout-header">
    <h3 style="margin:0;">Your Orders</h3>
    <div style="display:flex;gap:8px;">
      <button id="refreshStatusBtn" class="close-btn" type="button" style="padding:.3rem .8rem;font-size:.85rem;">Refresh Status</button>
      <button id="closeCartBtn" class="close-btn" type="button" style="padding:.3rem .8rem;font-size:.85rem;">Close</button>
    </div>
  </div>
  <div class="cart-flyout-body" id="cartFlyoutBody">
    <!-- orders rendered here -->
  </div>
</div>

<!-- Confirmation modal for removing orders -->
<div class="modal-overlay is-hidden" id="confirmRemovalOverlay" aria-hidden="true">
  <div class="modal" style="width: auto; max-width: 400px;">
    <h3 style="margin-top:0; margin-bottom: 1rem;">Confirm Removal</h3>
    <p id="confirmMessage" style="margin-bottom: 1.5rem; line-height: 1.5;"></p>
    <div style="display:flex;gap:10px;">
      <button id="confirmYesBtn" class="close-btn" style="flex:1;">Yes, Remove</button>
      <button id="confirmNoBtn" class="close-btn" style="flex:1;">Cancel</button>
    </div>
  </div>
</div>

<!-- overlay behind cart flyout (click to close) -->
<div class="cart-flyout-overlay is-hidden" id="cartFlyoutOverlay" aria-hidden="true"></div>

  <!-- temporary auth banner (controlled by JS) -->
  <div id="authBanner" class="auth-banner is-hidden" role="status" aria-live="polite">
    <span id="authBannerMsg">Successful Authentication</span>
  </div>

  <script src="/assets/js/site.js"></script>
</body>
</html>
